node.require("fs"),node.require("nedb"),node.require("path"),node.require("mkdirp"),node.require("cwebp"),node.require("semver"),node.require("url");var Q=node.require("q"),request=node.require("request"),jf=require("jsonfile"),server_ip="203.104.209.23",proxy="http://127.0.0.1:8118",_comp={};_g.inputIndex=0,_g.animate_duration_delay=320,_g.execPath=node.path.dirname(process.execPath),_g.path={db:process.cwd()+"/data/",fetched:{ships:process.cwd()+"/fetched_data/ships/",items:process.cwd()+"/fetched_data/items/"},pics:{ships:process.cwd()+"/pics/ships/",items:process.cwd()+"/pics/items/"}},_g.pathMakeObj=function(e){for(var a in e)"object"==typeof e[a]?_g.pathMakeObj(e[a]):node.mkdirp.sync(e[a])},_g.pathMakeObj(_g.path),_g.data={ships:{},ship_id_by_type:[],ship_types:{},items:{},item_types:{}};var _db={ships:new node.nedb({filename:_g.path.db+"/ships.json"}),ship_types:new node.nedb({filename:_g.path.db+"/ship_types.json"}),ship_type_collections:new node.nedb({filename:_g.path.db+"/ship_type_collections.json"}),ship_type_order:new node.nedb({filename:_g.path.db+"/ship_type_order.json"}),ship_classes:new node.nedb({filename:_g.path.db+"/ship_classes.json"}),ship_series:new node.nedb({filename:_g.path.db+"/ship_series.json"}),ship_namesuffix:new node.nedb({filename:_g.path.db+"/ship_namesuffix.json"}),items:new node.nedb({filename:_g.path.db+"/items.json"}),item_types:new node.nedb({filename:_g.path.db+"/item_types.json"}),item_type_collections:new node.nedb({filename:_g.path.db+"/item_type_collections.json"}),entities:new node.nedb({filename:_g.path.db+"/entities.json"}),updates:new node.nedb({filename:_g.path.db+"/updates.json"}),arsenal_all:new node.nedb({filename:_g.path.db+"/arsenal_all.json"}),arsenal_weekday:new node.nedb({filename:_g.path.db+"/arsenal_weekday.json"})};_g.ship_type_order=[],_g.ship_type_order_name=[],_g.ship_type_order_map={},_g.newInputIndex=function(){return _g.inputIndex++,"_input_g"+(_g.inputIndex-1)},_g.statSpeed={5:"低速",10:"高速"},_g.statRange={1:"短",2:"中",3:"长",4:"超长"},_g.getStatSpeed=function(e){return e=parseInt(e),_g.statSpeed[e]},_g.getStatRange=function(e){return e=parseInt(e),_g.statRange[e]},_g.log=function(e){console.log(e);try{_log(e)}catch(a){}},_frame.app_main={page:{},page_dom:{},bgimg_dir:"./app/assets/images/homebg",bgimgs:[],loading:["dbs","bgimgs","db_namesuffix"],loaded:function(e){_frame.app_main.loading.splice(_frame.app_main.loading.indexOf(e),1),_frame.app_main.loading.length||_frame.app_main.is_loaded||(setTimeout(function(){_frame.dom.layout.addClass("ready")},1e3),$(window).on("hashchange.pagechange",function(){_frame.app_main.load_page_func(_g.uriHash("page"))}),_frame.app_main.load_page_func(_g.uriHash("page")),_frame.app_main.is_loaded=!0)},change_bgimg:function(){function e(e){setTimeout(function(){e.remove()},_g.animate_duration_delay)}if(!_frame.app_main.bgimgs.length)return!1;var a=_frame.app_main.bgimgs[_g.randInt(_frame.app_main.bgimgs.length-1)],n=_frame.app_main.cur_bgimg_el?_frame.app_main.cur_bgimg_el.css("background-image"):null;for(n=n?n.split("/"):null,n=n?n[n.length-1].split(")"):null,n=n?n[0]:null;a==n;)a=_frame.app_main.bgimgs[_g.randInt(_frame.app_main.bgimgs.length-1)];a="."+_frame.app_main.bgimg_dir+"/"+a,n&&e(_frame.app_main.cur_bgimg_el),_frame.app_main.cur_bgimg_el=$("<div/>").css("background-image","url("+a+")").appendTo(_frame.dom.bgimg)},toggle_hidecontent:function(){_frame.dom.layout.toggleClass("hidecontent")},load_page:function(e){_g.uriHash("page",e)},load_page_func:function(e){return _frame.app_main.cur_page!=e&&e?(_frame.app_main.page_dom[e]||(_frame.app_main.page_dom[e]=$('<div class="page" page="'+e+'"/>').appendTo(_frame.dom.main),node.fs.readFile("./app/page/"+e+".html","utf8",function(a,n){if(a)throw a;_frame.app_main.page_dom[e].html(n),_frame.app_main.page[e]&&_frame.app_main.page[e].init&&_frame.app_main.page[e].init(_frame.app_main.page_dom[e]),_p.initDOM(_frame.app_main.page_dom[e])})),_frame.app_main.page_dom[e].removeClass("off"),_frame.app_main.cur_page&&(_frame.dom.navs[_frame.app_main.cur_page].removeClass("on"),_frame.app_main.page_dom[_frame.app_main.cur_page].addClass("off")),_frame.dom.navs[e].addClass("on"),_frame.dom.layout.hasClass("ready")&&_frame.app_main.change_bgimg(),void(_frame.app_main.cur_page=e)):e},init:function(){function e(e){return $("<button />").on("click",function(){_frame.app_main.load_page(e)})}function a(e){_db[e].loadDatabase(function(a){function n(){for(var e in _g.ship_type_order){var a=parseInt(e);if("object"==typeof _g.ship_type_order[e])for(var n in _g.ship_type_order[e])_g.ship_type_order_map[_g.ship_type_order[e][n]]=a;else _g.ship_type_order_map[_g.ship_type_order[e]]=a}}if(a);else{switch(p++,e){case"item_types":_db.item_types.find({},function(e,a){for(var n in a)_g.data.item_types[a[n].id]=a[n]});break;case"ship_namesuffix":_db.ship_namesuffix.find({}).sort({id:1}).exec(function(e,a){_g.data.ship_namesuffix=[{}].concat(a),_frame.app_main.loaded("db_namesuffix")});break;case"ship_types":_db.ship_types.find({},function(e,a){for(var n in a)_g.data.ship_types[a[n].id]=a[n]});break;case"ship_type_order":_db.ship_type_order.find({}).sort({id:1}).exec(function(e,a){for(var t in a)_g.ship_type_order.push(a[t].types.length>1?a[t].types:a[t].types[0]),_g.ship_type_order_name.push(a[t].name);n()})}p>=i&&_frame.app_main.loaded("dbs")}})}if(_frame.app_main.is_init)return!0;if(_frame.dom.aside=$("<aside/>").appendTo(_frame.dom.layout),_frame.dom.logo=$('<button class="logo" />').on("click",function(){_frame.app_main.toggle_hidecontent()}).html("<strong>"+node.gui.App.manifest.name+"</strong><b>"+node.gui.App.manifest.name+"</b>").on({"animationend, webkitAnimationEnd":function(e){$(this).addClass("ready-animated")}}).appendTo(_frame.dom.aside),_frame.dom.nav=$("<nav/>").appendTo(_frame.dom.aside),_frame.dom.main=$("<main/>").appendTo(_frame.dom.layout),_frame.dom.bgimg=$('<div class="bgimg" />').appendTo(_frame.dom.layout),_frame.app_main.nav&&_frame.app_main.nav.length){_frame.dom.navs={};for(var n in _frame.app_main.nav){var t=_frame.app_main.nav[n];_frame.dom.navs[t.page]=e(t.page).html(t.title).appendTo(_frame.dom.nav),0!=n||_g.uriHash("page")||_frame.dom.navs[t.page].trigger("click")}}node.fs.readdir(_frame.app_main.bgimg_dir,function(e,a){for(var n in a)_frame.app_main.bgimgs.push(a[n]);_frame.app_main.change_bgimg(),_frame.app_main.loaded("bgimgs")});var i=0,p=0;for(var n in _db)i++;for(var n in _db)a(n);$("html").on("click.openShipModal","[data-shipid]",function(){if("false"==$(this).data("shipmodal"))return!1;if($(this).data("shipedit"))_frame.app_main.page.ships.show_ship_form(_g.data.ships[$(this).data("shipid")]);else try{_frame.app_main.show_ship(_g.data.ships[$(this).data("shipid")])}catch(e){console.log(e)}}).on("click.openItemModal","[data-itemid]",function(){if("false"==$(this).data("itemmodal"))return!1;if($(this).data("itemedit"))_frame.app_main.page.items.show_item_form(_g.data.items[$(this).data("itemid")]);else try{_frame.app_main.show_item(_g.data.items[$(this).data("itemid")])}catch(e){console.log(e)}}),_frame.app_main.is_init=!0}},_frame.app_main.page.home={},node.require("http"),node.require("url"),_frame.app_main.page.init={},_frame.app_main.page.init.data_ships=null,_frame.app_main.page.init.fetch_ships=function(){_log("fetching data for ships...");var url=node.url.parse($("#data_ships").val()),req=node.http.request({hostname:url.hostname,path:url.path,method:"GET",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.115 Safari/537.36"}},function(res){if(200==res.statusCode){res.setEncoding("utf8");var body="";res.on("data",function(e){body+=e}),res.on("end",function(){function savedata_next(){_frame.app_main.page.init.data_ships.shift(),_frame.app_main.page.init.data_ships.length?setTimeout(function(){savedata()},10):(_log("all data for ships saved."),_frame.app_main.page.init.fetch_items())}function savedata(){var e=_frame.app_main.page.init.data_ships[0];_db.ships.find({id:parseInt(e.id)},function(a,n){!a&&n&&n.length?(_log("data for ship ["+e.id+"] No."+e.no+" "+e.name+" exists in database. skip."),savedata_next()):node.fs.writeFile(_g.path.fetched.ships+"/"+e.id+".json",JSON.stringify(e),function(a){a?console.log(a):_log("saved data file for ship ["+e.id+"] No."+e.no+" "+e.name+"."),savedata_next()})})}body=body.replace(/^var [^ ^\=]+[ ]*=/,""),eval("_frame.app_main.page['init'].data_ships = "+body),_log("fetched data for ships ("+_frame.app_main.page.init.data_ships.length+")."),node.mkdirp.sync(_g.path.fetched.ships),savedata()})}else _log("fetching error: CODE "+res.statusCode)});req.end()},_frame.app_main.page.init.data_items=null,_frame.app_main.page.init.fetch_items=function(){_log("fetching data for items...");var url=node.url.parse($("#data_items").val()),req=node.http.request({hostname:url.hostname,path:url.path,method:"GET",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.115 Safari/537.36"}},function(res){if(200==res.statusCode){res.setEncoding("utf8");var body="";res.on("data",function(e){body+=e}),res.on("end",function(){function savedata_next(){_frame.app_main.page.init.data_items.shift(),_frame.app_main.page.init.data_items.length?setTimeout(function(){savedata()},10):_log("all data for items saved.")}function savedata(){var e=_frame.app_main.page.init.data_items[0];_db.items.find({id:parseInt(e.id)},function(a,n){!a&&n&&n.length?(_log("data for item ["+e.id+"] "+e.name+" exists in database. skip."),savedata_next()):node.fs.writeFile(_g.path.fetched.items+"/"+e.id+".json",JSON.stringify(e),function(a){a?console.log(a):_log("saved data file for item ["+e.id+"] "+e.name+"."),savedata_next()})})}body=body.replace(/^var [^ ^\=]+[ ]*=/,""),eval("_frame.app_main.page['init'].data_items = "+body),_log("fetched data for items ("+_frame.app_main.page.init.data_items.length+")."),node.mkdirp.sync(_g.path.fetched.items),savedata()})}else _log("fetching error: CODE "+res.statusCode)});req.end()},_frame.app_main.page.init.remain_illustrations=[],_frame.app_main.page.init.init_illustrations=function(){function e(){if(_frame.app_main.page.init.remain_illustrations.length){var a=_frame.app_main.page.init.remain_illustrations[0],n=node.path.normalize(_g.path.pics.ships+"/"+node.path.relative("./fetched_data/ships_pic/",a));node.fs.rename(a,n,function(a){_log("file moved to "+n+"."),_frame.app_main.page.init.remain_illustrations.shift(),setTimeout(function(){e()},10)})}else _log("all illustrations for ships files moved...")}_log("start initializing illustrations for ships..."),node.fs.readdir("./fetched_data/ships_pic/",function(a,n){if(!a)for(var t in n)_frame.app_main.page.init.remain_illustrations.push("./fetched_data/ships_pic/"+n[t]+"/0.jpg"),_frame.app_main.page.init.remain_illustrations.push("./fetched_data/ships_pic/"+n[t]+"/1.jpg"),_frame.app_main.page.init.remain_illustrations.push("./fetched_data/ships_pic/"+n[t]+"/2.jpg"),_frame.app_main.page.init.remain_illustrations.push("./fetched_data/ships_pic/"+n[t]+"/3.jpg"),_frame.app_main.page.init.remain_illustrations.push("./fetched_data/ships_pic/"+n[t]+"/8.png"),_frame.app_main.page.init.remain_illustrations.push("./fetched_data/ships_pic/"+n[t]+"/9.png"),_frame.app_main.page.init.remain_illustrations.push("./fetched_data/ships_pic/"+n[t]+"/10.png"),node.mkdirp.sync(_g.path.pics.ships+"/"+n[t]),t>=n.length-1&&e()})},_frame.app_main.page.init.exportdata=function(e){var a=e.find('[name="destfolder"]').val(),n=[],t=Q.fcall(function(){});t.then(function(){var e=Q.defer();return node.fs.readdir("./data/",function(a,t){a?e.reject(a):(n=t,e.resolve(t))}),e.promise}).then(function(){function e(e,n,p){_db.ships.find({equip:e},function(e,s){var o={};for(var r in s)"undefined"==typeof o[s[r].series]&&(o[s[r].series]=[]),o[s[r].series].push(s[r]);for(var r in o){o[r].sort(function(e,a){return e.name.suffix-a.name.suffix});for(var d in o[r])t[n].push(o[r][d].id)}p>=i-1&&a()})}function a(){function e(e,a,t){_db.items.update({_id:e},{$set:a},{},function(e,a){t>=i-1&&(_g.log("= 批处理完毕"),n.resolve())})}var a=0;for(var p in t){var s=[];$.each(t[p],function(e,a){-1===$.inArray(a,s)&&s.push(a)}),e(p,{default_equipped_on:s},a),a++}}var n=Q.defer(),t={},i=0;return _g.log("&nbsp;"),_g.log("========== 装备数据 - 初始装备于 =========="),_g.log("= 批处理开始"),_db.items.find({},function(a,n){for(var p in n){var s=n[p];t[s._id]=[],i++,e(s.id,s._id,p)}}),n.promise}).then(function(){function e(){function e(e,n,i){_db.items.update({_id:e},{$set:n},{},function(e,n){i>=t-1&&(_g.log("= 批处理完毕"),a.resolve())})}var i=0;for(var p in n)e(n[p][0],{upgrade_from:n[p][1]},i),i++}var a=Q.defer(),n={},t=0;return _g.log("&nbsp;"),_g.log("========== 装备数据 - 改修升级前后关系 =========="),_g.log("= 批处理开始"),_db.items.find({},function(a,i){for(var p in i){var s=i[p];if(n[s.id]||(n[s.id]=[null,[]]),n[s.id][0]=s._id,t++,s.upgrade_to&&s.upgrade_to.length)for(var o in s.upgrade_to){var r=s.upgrade_to[o][0];n[r]||(n[r]=[null,[]]),n[r][1].push(s.id)}}console.log(n),e()}),a.promise}).then(function(){var e=Q.defer(),a=[],n=[],t=[],i=Q.fcall(function(){});_g.log("&nbsp;"),_g.log("========== 改修工厂 - 每日改修 & 改修明细 =========="),_g.log("= 批处理开始");for(var p=0;7>p;p++)a[p]={weekday:p,improvements:[]},n[p]={};return i.then(function(){var e=Q.defer();return _db.items.find({}).sort({type:1,rarity:1,id:1}).exec(function(i,p){for(var s in p){var o=p[s];if(o.improvement&&o.improvement.length){t.push({id:o.id,sort:t.length});for(var r in o.improvement)for(var d in o.improvement[r].req)for(var _=o.improvement[r].req[d],l=0;7>l;l++)if(_[0][l]){var m=o.id+"_"+parseInt(r);"undefined"==typeof n[l][m]?(n[l][m]=a[l].improvements.length,a[l].improvements.push([o.id,parseInt(r),[parseInt(d)]])):a[l].improvements[n[l][m]][2].push(parseInt(d))}e.resolve()}}}),e.promise}).then(function(){var e=Q.defer();return _db.arsenal_all.remove({},{multi:!0},function(a,n){e.resolve()}),e.promise}).then(function(){var e=Q.defer();return _db.arsenal_weekday.remove({},{multi:!0},function(a,n){e.resolve()}),e.promise}).then(function(){var e=Q.defer();return _db.arsenal_all.insert(t,function(a,n){e.resolve()}),e.promise}).then(function(){var e=Q.defer();return _db.arsenal_weekday.insert(a,function(a,n){e.resolve()}),e.promise}).then(function(){_g.log("= 批处理完成"),e.resolve()}),e.promise}).then(function(){function e(e,a,n){function t(t){i||(n(t,e,a),i=!0)}var i=!1,p=node.fs.createReadStream(e);p.on("error",function(e){t(e)});var s=node.fs.createWriteStream(a);s.on("error",function(e){t(e)}),s.on("close",function(e){t()}),p.pipe(s)}function t(e,a,t){p++,e?console.log(e):_g.log("= 数据库JSON已复制到 "+t),p>=n.length&&(_g.log("= 全部数据库JSON已复制"),i.resolve())}var i=Q.defer(),p=0;_g.log("&nbsp;"),_g.log("========== 复制数据库JSON =========="),node.mkdirp.sync(a);for(var s in _db)_db[s].persistence.compactDatafile();for(var s in n)e("./data/"+n[s],a+"/"+n[s],t);return i.promise})["catch"](function(e){_g.log(e),_g.log("输出数据失败")}).done(function(){_g.log("输出数据初始过程结束")})},_frame.app_main.page.init.exportpic=function(e){function a(e,a,n,t){try{var i=node.fs.lstatSync(e);i&&i.isFile()&&s.push([e,a,n,t])}catch(p){}}function n(e,a,t,i){e=e||s[0][0],a=a||s[0][1],t=t||s[0][2]||75,i=i||s[0][3]||!1;var p=(e+(i?" -lossless":"")+" -q "+t+" -o "+a).split(/\s+/);d(_,p,function(e,t,i){e||(_log("pic file copied to "+a),s.shift(),n())})}var t=e.find('[name="destfolder"]').val(),i=node.fs.readdirSync("./pics/ships/"),p=node.fs.readdirSync("./pics/items/"),s=[],o={},r=Q.fcall(function(){});node.mkdirp.sync(t+"/ships/"),node.mkdirp.sync(t+"/items/");var d=require("child_process").execFile,_=require("webp-bin").path;return r.then(function(){return deferred=Q.defer(),_db.ship_series.find({},function(e,a){for(var n in a){var t=a[n].ships||[];for(var i in t)if(t[i].id){o[t[i].id]=[],o[t[i].id].push(["0.png","0.webp",90]),t[i].illust_delete||(o[t[i].id].push(["8.png","8.webp",85]),o[t[i].id].push(["9.png","9.webp",85]),o[t[i].id].push(["10.png","10.webp",75]));var p=t[i].illust_extra||[];for(var s in p)o["extra_"+p[s]]=[],o["extra_"+p[s]].push(["8.png","8.webp",85]),o["extra_"+p[s]].push(["9.png","9.webp",85])}deferred.resolve(o)}}),deferred.promise}).then(function(e){for(var n in i){node.mkdirp.sync(t+"/ships/"+i[n]);var o=e[i[n]]||null;o||(o=[],o.push(["0.png","0.webp",90]),o.push(["8.png","8.webp",85]),o.push(["9.png","9.webp",85]),o.push(["10.png","10.webp",75]));for(var r in o)a("./pics/ships/"+i[n]+"/"+o[r][0],t+"/ships/"+i[n]+"/"+o[r][1],o[r][2])}for(var n in p)node.mkdirp.sync(t+"/items/"+p[n]),a("./pics/items/"+p[n]+"/card.png",t+"/items/"+p[n]+"/card.webp",80);return s}).then(function(e){return n()}),!0},_frame.app_main.page.init.init=function(page){_log=function(e){$("<p/>").html(e).prependTo(logs)};var logs=$('<div class="logs">').appendTo(page);page.find("form#init_all_data").on("submit",function(e){var a=$(this);e.preventDefault(),a.addClass("submitting"),a.find('[type="submit"]').on("click",function(e){e.preventDefault()}),_frame.app_main.page.init.fetch_ships()}),page.find("form#init_illustrations").on("submit",function(e){var a=$(this);e.preventDefault(),a.addClass("submitting"),a.find('[type="submit"]').on("click",function(e){e.preventDefault()}),_frame.app_main.page.init.init_illustrations()}),page.find("form#init_exportdata").each(function(){var e=$(this),a=e.find('[name="destfolder"]'),n=e.find('[value="Browse..."]'),t=e.find('[type="file"]');e.on("submit",function(a){a.preventDefault(),e.addClass("submitting"),e.find('[type="submit"]').on("click",function(e){e.preventDefault()}),_frame.app_main.page.init.exportdata(e)}),a.val(_config.get("data_export_to")).on({change:function(){_config.set("data_export_to",$(this).val())},click:function(){n.trigger("click")}}),n.on("click",function(){}),t.on("change",function(){a.val($(this).val()).trigger("change")})}),page.find("form#init_exportpic").each(function(){var e=$(this),a=e.find('[name="destfolder"]'),n=e.find('[value="Browse..."]'),t=e.find('[type="file"]');e.on("submit",function(a){a.preventDefault(),e.addClass("submitting"),e.find('[type="submit"]').on("click",function(e){e.preventDefault()}),_frame.app_main.page.init.exportpic(e)}),a.val(_config.get("pics_export_to")).on({change:function(){_config.set("pics_export_to",$(this).val())},click:function(){n.trigger("click")}}),n.on("click",function(){}),t.on("change",function(){a.val($(this).val()).trigger("change")})}),page.find("form#fetch_official").on("submit",function(e){var form=$(this);e.preventDefault(),_log("开始获取官方游戏数据 (api_start2)...");var ip=form.find('[name="server_ip"]').val(),api_token=form.find('[name="api_token"]').val(),url=node.url.parse("http://"+ip+"/kcsapi/api_start2"),promise_chain=Q.fcall(function(){});promise_chain.then(function(){var api=node.url.parse("http://"+ip+"/kcsapi/api_start2"),deferred=Q.defer();_log("API (api_start2) requesting..."),request({uri:api,method:"POST",headers:{"Cache-Control":"no-cache","Content-Type":"application/x-www-form-urlencoded",Pragma:"no-cache",Referer:"http://"+ip+"/kcs/mainD2.swf?api_token="+api_token+"&api_starttime="+_g.timeNow()+"/[[DYNAMIC]]/1","User-Agent":"Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.115 Safari/537.36","X-Requested-With":"ShockwaveFlash/17.0.0.169"},formData:{api_token:api_token,api_verno:1},proxy:proxy},function(err,response,body){(err||200!=response.statusCode)&&(console.log(err,response),deferred.reject(new Error(err))),err||200!=response.statusCode||(eval(body),console.log(svdata),1==svdata.api_result?jf.writeFile(node.path.normalize(_g.root+"/fetched_data/api_start2.json"),svdata,function(e){e?deferred.reject(new Error(e)):deferred.resolve()}):(console.log(svdata),deferred.reject(new Error(err))))})})["catch"](function(e){_log(e)}).done(function(){_log("已获取，数据已保存到文件 /fetched_data/api_start2.json")})})},_frame.app_main.page.ships={},_frame.app_main.page.ships.section={},_frame.app_main.page.ships.gen_table=function(e){var a=$("<table/>");return a},_frame.app_main.page.ships.gen_input=function(e,a,n,t,i){switch(i=i||{},e){case"text":case"number":case"hidden":var p=$("<input/>",{type:e,name:a,id:n}).val(t);break;case"select":var p=$("<select/>",{name:a,id:n}),s=$('<option value=""/>').html("").appendTo(p);for(var o in t){if("object"==typeof t[o])var r=$('<option value="'+("undefined"==typeof t[o].val?t[o].value:t[o].val)+'"/>').html(t[o].title||t[o].name).appendTo(p);else var r=$('<option value="'+t[o]+'"/>').html(t[o]).appendTo(p);"undefined"!=typeof i["default"]&&r.val()==i["default"]&&r.prop("selected",!0),r.val()||r.attr("disabled",!0)}t&&t.length||(s.remove(),$('<option value=""/>').html("...").appendTo(p)),i["new"]&&($('<option value="" disabled/>').html("==========").insertAfter(s),$('<option value="___new___"/>').html("+ 新建").insertAfter(s),p.on("change.___new___",function(){var e=$(this);"___new___"==e.val()&&(e.val(""),i["new"](p))}));break;case"select_group":var p=$("<select />",{name:a,id:n}),s=$('<option value=""/>').html("").appendTo(p);for(var o in t){var d=$('<optgroup label="'+t[o][0]+'"/>').appendTo(p);for(var _ in t[o][1]){var l=t[o][1][_];if("object"==typeof l)var r=$('<option value="'+("undefined"==typeof l.val?l.value:l.val)+'"/>').html(l.title||l.name).appendTo(d);else var r=$('<option value="'+l+'"/>').html(l).appendTo(d);"undefined"!=typeof i["default"]&&r.val()==i["default"]&&r.prop("selected",!0),r.val()||r.attr("disabled",!0)}}t&&t.length||(s.remove(),$('<option value=""/>').html("...").appendTo(p)),i["new"]&&($('<option value="" disabled/>').html("==========").insertAfter(s),$('<option value="___new___"/>').html("+ 新建").insertAfter(s),p.on("change.___new___",function(){var e=$(this);"___new___"==e.val()&&(e.val(""),i["new"](p))}));break;case"checkbox":var p=$("<input/>",{type:e,name:a,id:n}).prop("checked",t)}return i.required&&p.prop("required",!0),i.onchange&&(p.on("change.___onchange___",function(){i.onchange($(this))}),i["default"]&&p.trigger("change")),a||p.attr("name",null),p},_frame.app_main.page.ships.gen_form_line=function(e,a,n,t,i,p){var s=$("<p/>"),o="_input_g"+_g.inputIndex;return $('<label for="'+o+'"/>').html(n).appendTo(s),_frame.app_main.page.ships.gen_input(e,a,o,t,p).appendTo(s),i&&$('<label for="'+o+'"/>').html(i).appendTo(s),_g.inputIndex++,s},_frame.app_main.page.ships.show_ship_form=function(d){function _input(name,label,suffix,options){return _frame.app_main.page.ships.gen_form_line("text",name,label,eval("d."+name)||"",suffix,options)}function _stat(e,a){var n=$("<p/>"),t="_input_g"+_g.inputIndex;switch(_g.inputIndex++,e){case"consum":$('<label for="'+t+'"/>').html("燃料").appendTo(n);var i=_frame.app_main.page.ships.gen_input("number","consum.fuel",t,d.consum.fuel).appendTo(n);t="_input_g"+_g.inputIndex,_g.inputIndex++,$('<label for="'+t+'"/>').html("弹药").appendTo(n),_frame.app_main.page.ships.gen_input("number","consum.ammo",t,d.consum.ammo).appendTo(n);break;case"speed":var p=d.stat[e];$('<label for="'+t+'"/>').html(a).appendTo(n);var i=_frame.app_main.page.ships.gen_input("select","stat."+e,t,[{value:"5",title:"低速"},{value:"10",title:"高速"}],{"default":p}).appendTo(n);$('<label for="'+t+'"/>').html("当前值: "+p).appendTo(n);break;case"range":var p=d.stat[e];$('<label for="'+t+'"/>').html(a).appendTo(n);var i=_frame.app_main.page.ships.gen_input("select","stat."+e,t,[{value:"1",title:"短"},{value:"2",title:"中"},{value:"3",title:"长"},{value:"4",title:"超长"}],{"default":p}).appendTo(n);$('<label for="'+t+'"/>').html("当前值: "+p).appendTo(n);break;default:var p=d.stat[e];$('<label for="'+t+'"/>').html(a).appendTo(n);var i=_frame.app_main.page.ships.gen_input("number","stat."+e,t,p).appendTo(n);"carry"==e&&i.prop("readonly",!0),"carry"==e?$('<label for="'+t+'"/>').html("在“装备”页修改").appendTo(n):(t="_input_g"+_g.inputIndex,_g.inputIndex++,$('<label for="'+t+'"/>').html("最大").appendTo(n),_frame.app_main.page.ships.gen_input("number","stat."+e+"_max",t,d.stat[e+"_max"]).appendTo(n))}return n}function _slot(e,a,n){var t=$("<p/>"),i="_input_g"+_g.inputIndex;return _g.inputIndex++,$('<label for="'+i+'"/>').html("#<span>"+e+"</span> 搭载").appendTo(t),_frame.app_main.page.ships.gen_input("number","slot",i,a).on({"change, input":function(){var e=0;details_slot.find('input[name="slot"]').each(function(){e+=parseInt($(this).val())})}}).appendTo(t),i="_input_g"+_g.inputIndex,_g.inputIndex++,$('<label for="'+i+'"/>').html("初始装备").appendTo(t),_comp.selector_equipment("equip","",n).appendTo(t),$('<button type="button" class="delete"/>').html("&times;").on("click",function(){t.remove(),details_slot.find('input[name="slot"]').each(function(e){$(this).parent().find("label span").eq(0).html(e+1)})}).appendTo(t),t}function _link(e,a,n){var t=$("<p/>"),i="_input_g"+_g.inputIndex;return _g.inputIndex++,$('<label for="'+i+'"/>').appendTo(t),_frame.app_main.page.ships.gen_input("text","link_name",i,a,{notRequired:!0}).appendTo(t),i="_input_g"+_g.inputIndex,_g.inputIndex++,$('<label for="'+i+'"/>').html("URL").appendTo(t),_frame.app_main.page.ships.gen_input("text","link_url",i,n,{notRequired:!0}).appendTo(t),t}function _series(e,a){var n=$("<p/>"),t="_input_g"+_g.inputIndex;switch(_g.inputIndex++,e){case"remodel":$('<label for="'+t+'" class="remodel"/>').html("改造前ID").appendTo(n);_frame.app_main.page.ships.gen_input("number","series.remodel_prev",t,d_series.remodel_prev||null,{notRequired:!0}).appendTo(n);t="_input_g"+_g.inputIndex,_g.inputIndex++,$('<label for="'+t+'"/>').html("等级").appendTo(n),_frame.app_main.page.ships.gen_input("number","series.remodel_prev_lvl",t,d_series.remodel_prev_lvl||null,{notRequired:!0}).appendTo(n),t="_input_g"+_g.inputIndex,_g.inputIndex++,_frame.app_main.page.ships.gen_input("checkbox","series.remodel_prev_blueprint",t,d_series.remodel_prev_blueprint||!1,{notRequired:!0}).appendTo(n),$('<label for="'+t+'"/>').html("蓝图").appendTo(n);var i=$("<p/>");t="_input_g"+_g.inputIndex,_g.inputIndex++,$('<label for="'+t+'" class="remodel"/>').html("改造后ID").appendTo(i);_frame.app_main.page.ships.gen_input("number","series.remodel_next",t,d_series.remodel_next||null,{notRequired:!0}).appendTo(i);t="_input_g"+_g.inputIndex,_g.inputIndex++,$('<label for="'+t+'"/>').html("等级").appendTo(i),_frame.app_main.page.ships.gen_input("number","series.remodel_next_lvl",t,d_series.remodel_next_lvl||null,{notRequired:!0}).appendTo(i),t="_input_g"+_g.inputIndex,_g.inputIndex++,_frame.app_main.page.ships.gen_input("checkbox","series.remodel_next_blueprint",t,d_series.remodel_next_blueprint||!1,{notRequired:!0}).appendTo(i),$('<label for="'+t+'"/>').html("蓝图").appendTo(i),t="_input_g"+_g.inputIndex,_g.inputIndex++;_frame.app_main.page.ships.gen_input("hidden","base_lvl",t,d_series.remodel_prev_lvl||1,{notRequired:!0}).appendTo(i);n=n.add(i);break;case"illust_delete":_frame.app_main.page.ships.gen_input("checkbox","series.illust_delete",t,d_series.illust_delete||!1,{notRequired:!0}).addClass("delete_illust").appendTo(n),$('<label for="'+t+'"/>').html("删除该舰娘图鉴大图").appendTo(n);break;case"illust_extra":var p=a?parseInt(a)+1:1;$('<label for="'+t+'" class="extra_illust"/>').html("额外图鉴#"+p+" extra_").appendTo(n);_frame.app_main.page.ships.gen_input("number","series.illust_extra",t,d_series.illust_extra[a?a:0]||null,{notRequired:!0}).appendTo(n)}return n}d.remodel=d.remodel||{},d.rels=d.rels||{},d.slot=d.slot||[],d.equip=d.equip||[],console.log(d);var form=$('<form class="shipinfo new"/>'),base=$('<div class="base"/>').appendTo(form),details=$('<div class="tabview"/>').appendTo(form),_id=d._id?$('<input type="hidden"/>').val(d._id):null,details_stat=$('<section data-tabname="属性"/>').appendTo(details),details_slot=$('<section data-tabname="装备"/>').appendTo(details),details_misc=$('<section data-tabname="其他"/>').appendTo(details),details_series=$('<section data-tabname="系列"/>').appendTo(details),details_additional_equip_types=$('<section data-tabname="额外装备类型"/>').appendTo(details),base_image=$('<div class="image"/>').css("background-image","url(../pics/ships/"+d.id+"/2.png)").appendTo(base);_input("id","ID",null,{required:!0}).appendTo(base),_input("no","图鉴ID",null,{required:!0}).appendTo(base);var h4=$("<h4/>").html("舰娘名").appendTo(base),checkbox_id="_input_g"+_g.inputIndex;_g.inputIndex++;var _checkbox=_frame.app_main.page.ships.gen_input("checkbox",null,checkbox_id,!1,{onchange:function(e){e.prop("checked")?(base.find('input[name^="name."]').not('input[name="name.suffix"]').prop("required",!1),base.find('select[name="name.suffix"]').prop("required",!0)):(base.find('input[name^="name."]').not('input[name="name.suffix"]').prop("required",!0),base.find('select[name="name.suffix"]').prop("required",!1))}}).insertBefore(h4);$('<label for="'+checkbox_id+'" class="name_suffix"/>').html("仅后缀").insertBefore(_checkbox),_input("name.ja_jp","<small>日</small>").appendTo(base),_input("name.ja_kana","<small>日假名</small>").appendTo(base),_input("name.ja_romaji","<small>罗马音</small>").appendTo(base),_input("name.zh_cn","<small>简中</small>").appendTo(base);var base_suffix=_frame.app_main.page.ships.gen_form_line("select","name.suffix","后缀名",[],null,{notRequired:!0}).appendTo(base);_db.ship_namesuffix.find({}).sort({id:1}).exec(function(e,a){if(!e){var n=[],t=base_suffix.find("select");for(var i in a)n.push({value:a[i].id,title:a[i].zh_cn});_frame.app_main.page.ships.gen_input("select",t.attr("name"),t.attr("id"),n,{"default":d.name.suffix,notRequired:!0,"new":function(e){console.log("NEW SHIP SUFFIX",e)}}).insertBefore(t),t.remove()}}),_stat("fire","火力").appendTo(details_stat),_stat("torpedo","雷装").appendTo(details_stat),_stat("aa","对空").appendTo(details_stat),_stat("asw","对潜").appendTo(details_stat),_stat("hp","耐久").appendTo(details_stat),_stat("armor","装甲").appendTo(details_stat),_stat("evasion","回避").appendTo(details_stat),_stat("carry","搭载").appendTo(details_stat),_stat("speed","速力").appendTo(details_stat),_stat("range","射程").appendTo(details_stat),_stat("los","索敌").appendTo(details_stat),_stat("luck","　运").appendTo(details_stat),$("<h4/>").html("消耗").appendTo(details_stat),_stat("consum").appendTo(details_stat);for(var i=0;i<Math.max(d.slot.length,d.equip.length);i++)_slot(i+1,d.slot[i]||0,d.equip[i]||null).appendTo(details_slot);var btn_add_slot=$('<button class="add" type="button"/>').on("click",function(){_slot(details_slot.find('input[name="slot"]').length+1,0,null).insertBefore(btn_add_slot)}).html("添加栏位").appendTo(details_slot),_misc_cv=_frame.app_main.page.ships.gen_form_line("select","rels.cv","声优",[]).appendTo(details_misc);_db.entities.find({}).sort({id:1}).exec(function(e,a){if(!e){var n=[],t=_misc_cv.find("select");for(var i in a)n.push({value:a[i].id,title:a[i].name.zh_cn});_frame.app_main.page.ships.gen_input("select",t.attr("name"),t.attr("id"),n,{"default":d.rels.cv,"new":function(e){console.log("NEW ENTITY",e)}}).insertBefore(t),t.remove()}});var _misc_illustrator=_frame.app_main.page.ships.gen_form_line("select","rels.illustrator","画师",[]).appendTo(details_misc);_db.entities.find({}).sort({id:1}).exec(function(e,a){if(!e){var n=[],t=_misc_illustrator.find("select");for(var i in a)n.push({value:a[i].id,title:a[i].name.zh_cn});_frame.app_main.page.ships.gen_input("select",t.attr("name"),t.attr("id"),n,{"default":d.rels.illustrator,"new":function(e){console.log("NEW ENTITY",e)}}).insertBefore(t),t.remove()}}),$("<h4/>").html("舰种&舰级").appendTo(details_misc);var base_type=_frame.app_main.page.ships.gen_form_line("select","type","舰种",[]).appendTo(details_misc);_db.ship_types.find({}).sort({code:1,full:1}).exec(function(e,a){if(!e){var n=[],t=base_type.find("select");for(var i in a)n.push({value:a[i].id,title:"["+a[i].code+"] "+a[i].full_zh});_frame.app_main.page.ships.gen_input("select",t.attr("name"),t.attr("id"),n,{"default":d.type,"new":function(e){console.log("NEW SHIP TYPE",e)},onchange:function(e){base_class_select.html('<option value=""/>...</option>'),_db.ship_classes.find({ship_type_id:parseInt(e.val())},function(e,a){if(!e){var n=[],t=base_class_select;
for(var i in a)n.push({value:a[i].id,title:a[i].name_zh+"级"});a&&a.length||n.push({value:"",title:""}),base_class_select=_frame.app_main.page.ships.gen_input("select",t.attr("name"),t.attr("id"),n,{"new":function(e){console.log("NEW SHIP CLASS",e)}}).insertBefore(t),t.remove(),d.type&&base_type.find("select").val()==d.type&&base_class_select.val(d["class"])}})}}).insertBefore(t),t.remove()}});var base_class=_frame.app_main.page.ships.gen_form_line("select","class","舰级",[]).appendTo(details_misc),base_class_select=base_class.find("select");_input("class_no","编号","号舰").appendTo(details_misc),_form.section_order("链接",function(e,a){return _link(a+1,e.name||null,e.url||null)},$.extend(!0,[{name:"日文WIKI",url:null},{name:"英文WIKI",url:null}],d.links)).appendTo(details_misc);var d_series={illust_extra:[]},d_series_true=null,d_series_true_index=null;_db.ship_series.find({id:d.series}).exec(function(e,a){if(!e&&a&&a.length){d_series_true=a[0];for(var n in a[0].ships){var t=parseInt(n);if(d.id==a[0].ships[t].id){d_series_true_index=t,t>0&&(d_series.remodel_prev=a[0].ships[t-1].id||null,d_series.remodel_prev_lvl=a[0].ships[t-1].next_lvl||null,d_series.remodel_prev_blueprint=a[0].ships[t-1].next_blueprint||!1),a[0].ships[t+1]&&(d_series.remodel_next=a[0].ships[t+1].id||null,d.remodel_next=d.remodel_next||a[0].ships[t+1].id||null),d_series.remodel_next_lvl=a[0].ships[t].next_lvl||null,d.remodel.next&&(d_series.remodel_next=parseInt(d.remodel.next)||null),d.remodel.next_lvl&&(d_series.remodel_next_lvl=parseInt(d.remodel.next_lvl)||null),d_series.remodel_next_blueprint=a[0].ships[t].next_blueprint||!1,d_series.illust_delete=a[0].ships[t].illust_delete||!1,d_series.illust_extra=a[0].ships[t].illust_extra||[];break}}d_series.remodel_prev||(d_series.remodel_prev=parseInt(d.remodel.prev)||null,d_series.remodel_prev_lvl=parseInt(d.remodel.prev_lvl)||null,d_series.remodel_prev_blueprint=d.remodel.prev_blueprint||!1)}else d_series.remodel_prev=parseInt(d.remodel.prev)||null,d_series.remodel_prev_lvl=parseInt(d.remodel.prev_lvl)||null,d_series.remodel_prev_blueprint=d.remodel.prev_blueprint||!1,d_series.remodel_next=parseInt(d.remodel.next)||null,d_series.remodel_next_lvl=parseInt(d.remodel.next_lvl)||null,d_series.remodel_next_blueprint=d.remodel.next_blueprint||!1,d.remodel_next=d.remodel_next||parseInt(d.remodel.next)||null;$("<h4/>").html("改造").appendTo(details_series),_series("remodel").appendTo(details_series),$("<h4/>").html("图鉴").appendTo(details_series),_series("illust_delete").appendTo(details_series);var i=d_series.illust_extra||[1];i.length||(i=[1]);for(var n in i)_series("illust_extra",n).appendTo(details_series);var p=$('<button class="add" type="button"/>').on("click",function(){_series("illust_extra",details_series.find('input[name="series.illust_extra"]').length).insertBefore(p)}).html("添加额外图鉴").appendTo(details_series);d.remodel_next=d.remodel_next||d_series.remodel_next,d.remodel_next&&$('<input type="hidden" name="remodel_next"/>').val(d.remodel_next).appendTo(details_series)}),_form.create_item_types("additional_item_types",d.additional_item_types||[]).appendTo(details_additional_equip_types);var line=$('<p class="actions"/>').appendTo(form);$('<button type="submit"/>').html(d._id?"编辑":"入库").appendTo(line),form.on("submit",function(e){function a(){function e(n,t){_db.ships.find({id:n},function(n,i){!n&&i&&i.length&&(o=i[0].series),t||o||!l.series.remodel_next?(console.log(o),_db.ship_series.find({id:o}).exec(function(e,n){if(!e&&n&&n.length){d_series_true=n[0];for(var t in n[0].ships){var i=parseInt(t);if(d.id==n[0].ships[i].id){d_series_true_index=i,i>0&&(l.series.remodel_prev=n[0].ships[i-1].id||null,l.series.remodel_prev_lvl=n[0].ships[i-1].next_lvl||null,l.series.remodel_prev_blueprint=n[0].ships[i-1].next_blueprint||!1),n[0].ships[i+1]&&(l.series.remodel_next=n[0].ships[i+1].id||null,l.remodel_next=n[0].ships[i+1].id||null),l.series.remodel_next_lvl=n[0].ships[i].next_lvl||null,d.remodel.next&&(l.series.remodel_next=parseInt(d.remodel.next)||null),d.remodel.next_lvl&&(l.series.remodel_next_lvl=parseInt(d.remodel.next_lvl)||null),l.series.remodel_next_blueprint=n[0].ships[i].next_blueprint||!1,l.series.illust_delete=n[0].ships[i].illust_delete||!1,l.series.illust_extra=n[0].ships[i].illust_extra||[];break}}}a()})):(console.log(o),e(l.series.remodel_next,!0))})}function a(){if(d_series_true){d_series_true_index||0===d_series_true_index||(d_series_true_index=d_series_true.ships.length),console.log(d_series_true,d_series_true_index,l);var e=d_series_true.ships.length,a=d_series_true_index>0?d_series_true.ships[d_series_true_index-1]:null,n=e-1>d_series_true_index?d_series_true.ships[d_series_true_index+1]:null;a&&(a.id=l.series.remodel_prev,a.next_lvl=l.series.remodel_prev_lvl,a.next_blueprint=l.series.remodel_prev_blueprint),d_series_true.ships[d_series_true_index]||(d_series_true.ships[d_series_true_index]={id:l.id}),d_series_true.ships[d_series_true_index].next_lvl=l.series.remodel_next_lvl,d_series_true.ships[d_series_true_index].next_blueprint=l.series.remodel_next_blueprint,d_series_true.ships[d_series_true_index].illust_delete=l.series.illust_delete,d_series_true.ships[d_series_true_index].illust_extra=l.series.illust_extra,n?n.id=l.series.remodel_next:l.series.remodel_next&&d_series_true.ships.push({id:l.series.remodel_next}),l.series=d_series_true.id,o=d_series_true.id,_db.ship_series.update({_id:d_series_true._id},{$set:d_series_true},{},function(e,a){console.log("SERIES UPDATE",d_series_true),i()})}else d_series_true={ships:[]},l.series.remodel_prev&&d_series_true.ships.push({id:l.series.remodel_prev,next_lvl:l.series.remodel_prev_lvl,next_blueprint:l.series.remodel_prev_blueprint}),d_series_true.ships.push({id:l.id,next_lvl:l.series.remodel_next_lvl,next_blueprint:l.series.remodel_next_blueprint,illust_delete:l.series.illust_delete,illust_extra:l.series.illust_extra}),l.series.remodel_next&&d_series_true.ships.push({id:l.series.remodel_next}),_db.ship_series.count({},function(e,a){d_series_true.id=parseInt(a)+1,_db.ship_series.insert(d_series_true,function(e,a){console.log("SERIES INSERT",a),l.series=a.id,o=a.id,i()})})}l.series.remodel_next&&(s=l.series.remodel_next,p={prev:l.id,prev_lvl:l.series.remodel_next_lvl,prev_blueprint:l.series.remodel_next_blueprint}),d_series_true||!l.series.remodel_prev&&!l.series.remodel_next?a():(o=null,l.series.remodel_prev?e(l.series.remodel_prev):l.series.remodel_next?e(l.series.remodel_next,!0):a())}function n(){function e(){_.length?_db.entities.find({id:l.rels[_[0]]||-1},function(a,n){if(!a&&n&&n.length){var t=n[0].rels||{};"undefined"==typeof t[_[0]]&&(t[_[0]]=[]),$.inArray(l.id,t[_[0]])<0&&t[_[0]].push(l.id);var i={rels:t};_db.entities.update({_id:n[0]._id},{$set:i},{},function(a,n){console.log("ENTITY UPDATE COMPLETE",n,i),_.shift(),e()})}else _.shift(),e()}):a()}e()}function t(){function e(){node.fs.unlink(_g.path.pics.ships+"/"+l.id+"/"+a[0],function(t){a.length?(a.shift(),e()):n()})}if(r){var a=["8.png","9.png","10.png"];e()}else n()}function i(){_id?(l.time_modified=_g.timeNow(),console.log("EDIT",l),_db.ships.update({_id:d._id},{$set:l},{},function(e,a){console.log("UPDATE COMPLETE",a,l),l._id=d._id;var n=_frame.app_main.page.ships.section["已入库"].dom.section.find('tr[data-shipId="'+l.id+'"]');_frame.app_main.page.ships.section["已入库"].dom.section.data("shiplist").append_ship(l).insertBefore(n),n.remove(),_frame.modal.hide()})):(l.time_created=_g.timeNow(),node.fs.unlink(_g.path.fetched.ships+"/"+l.id+".json",function(e){_db.ships.insert(l,function(e,a){console.log("INSERT COMPLETE",a);try{_frame.app_main.page.ships.section["未入库"].dom.table.find('tr[data-shipId="'+l.id+'"]').remove()}catch(n){}if(_frame.app_main.page.ships.section["已入库"].dom.section.data("shiplist").append_ship(a),_frame.modal.hide(),s)try{_frame.modal.resetContent(),_frame.app_main.page.ships.section["未入库"].dom.table.find('tr[data-shipId="'+s+'"]').trigger("click",[{name:{ja_romaji:a.name.ja_romaji,zh_cn:a.name.zh_cn},rels:{cv:a.rels.cv,illustrator:a.rels.illustrator},series:o,type:a.type,"class":a["class"],class_no:a.class_no}])}catch(n){}})}))}var p=null,s=null,o=null,r=!1,_=["cv","illustrator"];e.preventDefault();var l={};l=$(this).serializeObject(),l.class_no=parseInt(l.class_no),r=l.series.illust_delete,l.series.illust_extra.push||(l.series.illust_extra=[l.series.illust_extra]),l.slot?"object"!=typeof l.slot&&(l.slot=[l.slot]):l.slot=[],l.equip?"object"!=typeof l.equip&&(l.equip=[l.equip]):l.equip=[],"object"!=typeof l.additional_item_types&&"undefined"!=typeof l.additional_item_types&&(l.additional_item_types=[l.additional_item_types]),l.additional_item_types=l.additional_item_types||[],console.log(l,l.slot,l.equip),l.name.suffix||(l.name.suffix=null),l.links=[],details_misc.find('input[name="link_name"]').each(function(e){var a=$(this),n=$(this).parent(),t=n.find('input[name="link_url"]').val();a=a.val(),l.links.push({name:a,url:t})}),l.link_name=null,l.link_url=null,delete l.link_name,delete l.link_url;var m=0;for(var u in l.slot)m+=parseInt(l.slot[u]);l.stat.carry=m,t()}),_frame.modal.show(form,d.name.ja_jp||"未入库舰娘",{classname:"infos_form"})},_frame.app_main.page.ships.gen_form_new_ship_type=function(e){e=e||function(){};var a=_frame.app_main.page.ships.section["舰种&舰级"],n=$('<form class="new_ship_type"/>').on("submit",function(a){a.preventDefault();var n=$(this).serializeObject();_db.ship_types.count({},function(a,t){n.id=parseInt(t)+1,_db.ship_types.insert(n,e)})});a.field_input_text("code","舰种简称").appendTo(n),a.field_input_text("code_game","舰种简称 (游戏中)").appendTo(n),a.field_input_text("full","舰种全称").appendTo(n),a.field_input_text("full_game","舰种全称 (游戏中)").appendTo(n),a.field_input_text("full_zh","舰种全称 (中文)").appendTo(n);var t="_input_g"+_g.inputIndex;return _g.inputIndex++,$('<input type="checkbox" name="donotcompare" id="'+t+'">').prop("checked",!1).appendTo(n),$('<label for="'+t+'"/>').html("不参与属性表对比").appendTo(n),a.field_actions().appendTo(n),n},_frame.app_main.page.ships.gen_form_new_ship_class=function(e){e=e||function(){};var a=_frame.app_main.page.ships.section["舰种&舰级"],n=$('<form class="ship_class loading"/>').on("submit",function(a){a.preventDefault();var n=$(this).serializeObject();_db.ship_classes.count({},function(a,t){n.id=parseInt(t)+1,_db.ship_classes.insert(n,e)})});a.field_input_text("name_game","舰级名 (游戏中)",null,"型").appendTo(n),a.field_input_text("name_zh","舰级名 (中文)",null,"级").appendTo(n);var t=($("<p/>").appendTo(n),$('<select name="ship_type_id" required/>').html('<option value=""></option>').appendTo(n));return _db.ship_types.find({}).sort({code:1,full:1}).exec(function(e,a){if(!e){for(var i in a){var p=a[i];$("<option/>",{value:p.id,html:"["+p.code+"] "+p.full_zh}).appendTo(t)}n.removeClass("loading")}}),a.field_actions().appendTo(n),n},_frame.app_main.page.ships.gen_form_new_ship_suffix=function(e,a,n){e=e||function(){},is_edit=a;var t=_frame.app_main.page.ships.section["舰种&舰级"],i=$('<form class="ship_suffix'+(is_edit?" loading":"")+'"/>').on("submit",function(n){n.preventDefault();var t=$(this).serializeObject();is_edit?_db.ship_namesuffix.update({_id:a._id},{$set:t},{},function(a,n){e(t),_frame.modal.hide()}):_db.ship_namesuffix.count({},function(a,n){t.id=parseInt(n)+1,_db.ship_namesuffix.insert(t,e)})});return t.field_input_text("ja_jp","日",is_edit?a.ja_jp:null).appendTo(i),t.field_input_text("ja_romaji","罗马音",is_edit?a.ja_romaji:null).appendTo(i),t.field_input_text("zh_cn","简中",is_edit?a.zh_cn:null).appendTo(i),t.field_actions(is_edit?"更新":null,n?function(){_db.ship_namesuffix.remove({_id:a._id},{},function(e,a){n(),_frame.modal.hide()})}:null).appendTo(i),i},_frame.app_main.page.ships.gen_form_new_ship_type_collection=function(e,a,n){e=e||function(){},is_edit=a;var t=is_edit?a.types:[],i=_frame.app_main.page.ships.section["舰种&舰级"],p=$('<form class="ship_type_collection"/>').on("submit",function(n){n.preventDefault();var t=$(this).serializeObject();"object"!=typeof t.types&&"undefined"!=typeof t.types&&(t.types=[t.types]),is_edit?_db.ship_type_collections.update({_id:a._id},{$set:t},{},function(a,n){e(t),_frame.modal.hide()}):_db.ship_type_collections.count({},function(a,n){t.id=parseInt(n)+1,_db.ship_type_collections.insert(t,e)})});return i.field_input_text("name.zh_cn","简中",is_edit?a.name.zh_cn:null).appendTo(p),_db.ship_types.find({}).sort({id:1}).exec(function(e,s){for(var o in s){var r=parseInt(s[o].id),d="_input_g"+_g.inputIndex;_g.inputIndex++,$('<input type="checkbox" name="types" value="'+r+'" id="'+d+'"/>').prop("checked",$.inArray(r,t)>-1).appendTo(p),$('<label for="'+d+'"/>').html(s[o].full_zh).appendTo(p),$("<br/>").appendTo(p)}i.field_actions(is_edit?"更新":null,n?function(){_db.ship_type_collections.remove({_id:a._id},{},function(e,a){n(),_frame.modal.hide()})}:null).appendTo(p)}),p},_frame.app_main.page.ships.gen_form_new_ship_type_order=function(e,a,n){e=e||function(){},is_edit=a;var t=is_edit?a.types:[],i=_frame.app_main.page.ships.section["舰种&舰级"],p=$('<form class="ship_type_collection"/>').on("submit",function(n){n.preventDefault();var t=$(this).serializeObject();"object"!=typeof t.types&&"undefined"!=typeof t.types&&(t.types=[t.types]),is_edit?_db.ship_type_order.update({_id:a._id},{$set:t},{},function(a,n){e(t),_frame.modal.hide()}):_db.ship_type_order.count({},function(a,n){t.id=parseInt(n)+1,_db.ship_type_order.insert(t,e)})});i.field_input_text("name.zh_cn","简中",is_edit?a.name.zh_cn:null).appendTo(p);var s="_input_g"+_g.inputIndex;return _g.inputIndex++,$('<input type="checkbox" name="donotcompare" id="'+s+'">').prop("checked",is_edit?a.donotcompare:null).appendTo(p),$('<label for="'+s+'"/>').html("不参与属性表对比").appendTo(p),$("<hr/>").appendTo(p),_db.ship_types.find({}).sort({id:1}).exec(function(e,s){for(var o in s){var r=parseInt(s[o].id),d="_input_g"+_g.inputIndex;_g.inputIndex++,$('<input type="checkbox" name="types" value="'+r+'" id="'+d+'">').prop("checked",$.inArray(r,t)>-1).appendTo(p),$('<label for="'+d+'"/>').html(s[o].full_zh).appendTo(p),$("<br/>").appendTo(p)}i.field_actions(is_edit?"更新":null,n?function(){_db.ship_type_order.remove({_id:a._id},{},function(e,a){n(),_frame.modal.hide()})}:null).appendTo(p)}),p},_frame.app_main.page.ships.init=function(e){e.find("section").on({"tabview-show":function(){var e=$(this),a=e.data("tabname");_frame.app_main.page.ships.section[a]||(_frame.app_main.page.ships.section[a]={});var n=_frame.app_main.page.ships.section[a];switch(!n.is_init&&n.init&&(n.init(e),n.is_init=!0),a){case"未入库":}}})},_frame.app_main.page.ships.section["已入库"]={dom:{},init:function(e){_frame.app_main.page.ships.section["已入库"].dom.section=e}},_frame.app_main.page.ships.section["未入库"]={data:[],data_length:0,dom:{},append_table:function(e){function a(e){var a=$("<thead/>"),n=$("<tr/>").appendTo(a);for(var t in e)parseInt(t)?$("<td/>").html('<div class="th-inner">'+e[t]+"</div>").appendTo(n):$("<th/>").html('<div class="th-inner">'+e[t]+"</div>").appendTo(n);return a}function n(e){var a={id:e.id,no:e.no,name:{ja_jp:e.name,ja_kana:e.pron},stat:{fire:e.fire,fire_max:e.max_fire,torpedo:e.torpedo,torpedo_max:e.max_torpedo,aa:e.aac,aa_max:e.max_aac,asw:e.ass,asw_max:e.max_ass,hp:e.hp,hp_max:e.max_hp,armor:e.armor,armor_max:e.max_armor,evasion:e.evasion,evasion_max:e.max_evasion,carry:"",speed:e.speed,range:e.range,los:e.seek,los_max:e.max_seek,luck:e.luck,luck_max:e.max_luck},consum:{fuel:e.fuel,ammo:e.bullet},remodel:{prev:null,prev_lvl:null,next:e.next||null,next_lvl:e.nextlv||null},slot:e.carry,equip:e.equip,rels:{}},n=0;for(var t in e.carry)n+=parseInt(e.carry[t]);return a.stat.carry=n,a}function t(){var e=_frame.app_main.page.ships.section["未入库"].data[r];if(e&&"なし"!==e.name){var a=$('<tr data-shipId="'+e.id+'" data-shipModal="false"/>').on("click",function(a,t){_frame.app_main.page.ships.show_ship_form($.extend(!0,n(e),t||{}))}).appendTo(o),i=0;for(var p in e.carry)i+=e.carry[p];$("<th/>").html('<img src="../pics/ships/'+e.id+'/0.png"/><strong>'+e.name+"</strong>").appendTo(a),$('<td class="stat-fire"/>').html(e.max_fire).appendTo(a),$('<td class="stat-torpedo"/>').html(e.max_torpedo).appendTo(a),$('<td class="stat-aa"/>').html(e.max_aac).appendTo(a),$('<td class="stat-asw"/>').html(e.max_ass).appendTo(a),$('<td class="stat-hp"/>').html(e.hp).appendTo(a),$('<td class="stat-armor"/>').html(e.max_armor).appendTo(a),$('<td class="stat-evasion"/>').html(e.max_evasion).appendTo(a),$('<td class="stat-carry"/>').html(i).appendTo(a),$('<td class="stat-speed"/>').html(_g.getStatSpeed(e.speed)).appendTo(a),$('<td class="stat-range"/>').html(_g.getStatRange(e.range)).appendTo(a),$('<td class="stat-los"/>').html(e.seek+"<sup>"+e.max_seek+"</sup>").appendTo(a),$('<td class="stat-luck"/>').html(e.luck+"<sup>"+e.max_luck+"</sup>").appendTo(a)}r++,setTimeout(function(){t()},1)}var i=$('<div class="fixed-table-container"/>').appendTo(e),p=$('<div class="fixed-table-container-inner"/>').appendTo(i),s=$('<table class="ships hashover hashover-column"/>').appendTo(p);a([" ","火力","雷装","对空","对潜","耐久","装甲","回避","搭载","航速","射程","索敌","运"]).appendTo(s);var o=$("<tbody/>").appendTo(s),r=0;return t(),s},init:function(section){node.fs.readdir(_g.path.fetched.ships,function(err,files){for(var i in files)node.fs.readFile(_g.path.fetched.ships+"/"+files[i],"utf8",function(err,data){if(err)throw err;eval("var _data = "+data),_frame.app_main.page.ships.section["未入库"].data[_data.id]=_data,_frame.app_main.page.ships.section["未入库"].data_length++,_frame.app_main.page.ships.section["未入库"].data_length>=files.length&&(_frame.app_main.page.ships.section["未入库"].dom.table=_frame.app_main.page.ships.section["未入库"].append_table(section))});!err&&files&&files.length||$("<p/>").html("暂无内容...<br />请初始化数据").appendTo(section)})}},_frame.app_main.page.ships.section["舰种&舰级"]={dom:{ship_class:{}},field_input_text:function(e,a,n,t){var i=$("<p/>"),p=$("<label/>").appendTo(i);return $("<span/>").html(a).appendTo(p),$('<input type="text" required name="'+e+'" />').val(n).appendTo(p),t&&$("<span/>").html(t).appendTo(p),i},field_actions:function(e,a){var n=$('<p class="actions"/>');return $('<button type="submit"/>').html(e||"提交").appendTo(n),a&&$('<button type="button"/>').html("删除").on("click",function(){a()}).appendTo(n),n},content_ship_type:function(e){return"<strong>"+e.full_zh+"</strong><small>"+e.full_game+"</small><em>"+e.code+"</em>"},content_ship_class:function(e){return"<strong>"+e.name_zh+"级</strong><small>"+e.name_game+"型</small>"},titlebtn_ship_type:function(e){var a=_frame.app_main.page.ships.section["舰种&舰级"],n=$('<button class="ship_type"/>').html(a.content_ship_type(e)).on("click",function(){var t=$('<form class="ship_type loading"/>').on("submit",function(t){if(t.preventDefault(),!$(this).hasClass("submitting")&&!$(this).hasClass("loading")){$(this).addClass("submitting");var i=$(this).serializeObject();_db.ship_types.update({_id:e._id},{$set:i},{},function(e,t){n.html(a.content_ship_type(i)),_frame.modal.hide()})}});_db.ship_types.find({_id:e._id},function(i,p){if(!i){var s=p[0],o=a.field_input_text("id","ID",s.id).appendTo(t);o.find("input").prop("readonly",!0),a.field_input_text("code","舰种简称",s.code).appendTo(t),a.field_input_text("code_game","舰种简称 (游戏中)",s.code_game).appendTo(t),a.field_input_text("full","舰种全称",s.full).appendTo(t),a.field_input_text("full_game","舰种全称 (游戏中)",s.full_game).appendTo(t),a.field_input_text("full_zh","舰种全称 (中文)",s.full_zh).appendTo(t);var r="_input_g"+_g.inputIndex;_g.inputIndex++,$('<input type="checkbox" name="donotcompare" id="'+r+'">').prop("checked",s.donotcompare).appendTo(t),$('<label for="'+r+'"/>').html("不参与属性表对比").appendTo(t),a.field_actions("更新",function(){_db.ship_types.remove({_id:e._id},{},function(t,i){n.remove(),a.dom.ship_class[e._id]&&a.dom.ship_class[e._id].remove(),_frame.modal.hide()})}).appendTo(t),t.removeClass("loading")}}),_frame.modal.show(t,"编辑舰种")});return n},add_ship_type:function(e){var a=_frame.app_main.page.ships.section["舰种&舰级"];a.titlebtn_ship_type(e).appendTo(a.dom.section),a.dom.ship_class[e.id]=_p.el.flexgrid.create().addClass("ship_classes").appendTo(a.dom.section),_db.ship_classes.find({ship_type_id:e.id},function(e,n){if(!e)for(var t in n)a.add_ship_class(n[t])})},add_ship_class:function(e){if(!e)return!1;var a=_frame.app_main.page.ships.section["舰种&舰级"];a.dom.ship_class[e.ship_type_id].appendDOM($('<button class="unit"/>').html(a.content_ship_class(e)))},init:function(e){var a=_frame.app_main.page.ships.section["舰种&舰级"];a.dom.new_container=$('<div class="new_container"/>').appendTo(e),a.dom.ship_type_new=$("<button/>").html("新建舰种").on("click",function(){_frame.modal.show(_frame.app_main.page.ships.gen_form_new_ship_type(function(e,n){a.add_ship_type(n),_frame.modal.hide()}),"新建舰种")}).appendTo(a.dom.new_container),a.dom.ship_class_new=$("<button/>").html("新建舰级").on("click",function(){_frame.modal.show(_frame.app_main.page.ships.gen_form_new_ship_class(function(e,n){a.add_ship_class(n),_frame.modal.hide()}),"新建舰级")}).appendTo(a.dom.new_container),a.dom.section=$('<div class="main"/>').appendTo(e),_db.ship_types.find({}).sort({code:1,full:1}).exec(function(e,n){if(!e)for(var t in n)a.add_ship_type(n[t])})}},_frame.app_main.page.ships.section["后缀名"]={dom:{},content_ship_suffix:function(e){return"<strong>"+e.zh_cn+"</strong><small>"+e.ja_jp+"</small>"},titlebtn_ship_suffix:function(e){var a=_frame.app_main.page.ships.section["后缀名"],n=$('<button class="ship_suffix"/>').html(a.content_ship_suffix(e)).on("click",function(){_frame.modal.show(_frame.app_main.page.ships.gen_form_new_ship_suffix(function(e){n.html(a.content_ship_suffix(e))},e,function(){n.remove()}),"编辑后缀名")});return n},add_ship_suffix:function(e){var a=_frame.app_main.page.ships.section["后缀名"];a.titlebtn_ship_suffix(e).appendTo(a.dom.section)},init:function(e){var a=_frame.app_main.page.ships.section["后缀名"];a.dom.new_container=$('<div class="new_container"/>').appendTo(e),a.dom.btnnew=$("<button/>").html("新建").on("click",function(){_frame.modal.show(_frame.app_main.page.ships.gen_form_new_ship_suffix(function(e,n){a.add_ship_suffix(n),_frame.modal.hide()}),"新建舰名后缀")}).appendTo(a.dom.new_container),a.dom.section=$('<div class="main"/>').appendTo(e),_db.ship_namesuffix.find({}).sort({code:1,full:1}).exec(function(e,n){if(!e)for(var t in n)a.add_ship_suffix(n[t])})}},_frame.app_main.page.ships.section["新建"]={dom:{},init:function(e){var a=_frame.app_main.page.ships.section["新建"];_frame.app_main.page.ships.section["新建"].dom.section=e,a.dom.form=$("<form/>").on("submit",function(e){e.preventDefault();var n=a.dom.form.serializeObject(),t={name:{},stat:{},consum:{},slot:[],equip:[]};console.log(n),n.remodel_from>-1&&(remodel_from=_g.data.ships[n.remodel_from],t.name=remodel_from.name,t.type=remodel_from.type,t["class"]=remodel_from["class"],t.class_no=remodel_from.class_no,t.rels=remodel_from.rels,t.series=remodel_from.series,t.remodel={prev:remodel_from.id},delete t.name.suffix),n.id&&(t.id=n.id),n.no&&(t.no=n.no),_frame.app_main.page.ships.show_ship_form(t)}).data({ship_data:{}}).appendTo(e);var n="_input_g"+_g.inputIndex;_g.inputIndex++,$("<p/>").append($('<label for="'+n+'"/>').html("ID")).append($('<input id="'+n+'" type="number" name="id"/>')).appendTo(a.dom.form),$("<p/>").append($('<label for="'+n+'"/>').html("图鉴ID")).append($('<input id="'+n+'" type="number" name="no"/>')).appendTo(a.dom.form);var n="_input_g"+_g.inputIndex;_g.inputIndex++;var t=$("<p/>").append($('<label for="'+n+'"/>').html("改造自")).appendTo(a.dom.form);_comp.selector_ship("remodel_from",n).appendTo(t),$('<p class="actions"/>').append($('<button type="submit"/>').html("新建")).appendTo(a.dom.form)}},_frame.app_main.page.ships.section["舰种集合 (舰娘列表)"]={dom:{},content:function(e){return"<strong>"+e.name.zh_cn+"</strong>"},titlebtn:function(e){var a=_frame.app_main.page.ships.section["舰种集合 (舰娘列表)"],n=$('<div class="ship_type_collection"/>');$('<button class="ship_type_collection"/>').html(a.content(e)).on("click",function(){_frame.modal.show(_frame.app_main.page.ships.gen_form_new_ship_type_order(function(e){a.titlebtn(e).insertAfter(n),n.remove()},e,function(){n.remove()}),"编辑舰种集合")}).appendTo(n);var t=$("<div/>").appendTo(n);for(var i in e.types)$("<span/>").html(_g.data.ship_types[e.types[i]].full_zh+(parseInt(i)<e.types.length-1?", ":"")).appendTo(t);return n},add:function(e){var a=_frame.app_main.page.ships.section["舰种集合 (舰娘列表)"];a.titlebtn(e).appendTo(a.dom.ship_type_order)},init:function(e){var a=_frame.app_main.page.ships.section["舰种集合 (舰娘列表)"];_frame.app_main.page.ships.section["舰种集合 (舰娘列表)"].dom.section=e;a.dom.new_container=$('<div class="new_container"/>').appendTo(e),a.dom.btnnew=$("<button/>").html("新建").on("click",function(){_frame.modal.show(_frame.app_main.page.ships.gen_form_new_ship_type_order(function(e,n){a.add(n),_frame.modal.hide()}),"新建舰种集合")}).appendTo(a.dom.new_container),a.dom.ship_type_order=$('<div class="ship_type_collections"/>').appendTo(e),_db.ship_type_order.find({}).sort({id:1}).exec(function(e,n){if(!e&&n&&n.length)for(var t in n)a.add(n[t])})}},_frame.app_main.page.ships.section["舰种集合 (舰娘选择器)"]={dom:{},content:function(e){return"<strong>"+e.name.zh_cn+"</strong>"},titlebtn:function(e){var a=_frame.app_main.page.ships.section["舰种集合 (舰娘选择器)"],n=$('<div class="ship_type_collection"/>');$('<button class="ship_type_collection"/>').html(a.content(e)).on("click",function(){_frame.modal.show(_frame.app_main.page.ships.gen_form_new_ship_type_collection(function(e){a.titlebtn(e).insertAfter(n),n.remove()},e,function(){n.remove()}),"编辑舰种集合")}).appendTo(n);var t=$("<div/>").appendTo(n);for(var i in e.types)$("<span/>").html(_g.data.ship_types[e.types[i]].full_zh+(parseInt(i)<e.types.length-1?", ":"")).appendTo(t);return n},add:function(e){var a=_frame.app_main.page.ships.section["舰种集合 (舰娘选择器)"];a.titlebtn(e).appendTo(a.dom.ship_type_collections)},init:function(e){var a=_frame.app_main.page.ships.section["舰种集合 (舰娘选择器)"];_frame.app_main.page.ships.section["舰种集合 (舰娘选择器)"].dom.section=e;a.dom.new_container=$('<div class="new_container"/>').appendTo(e),a.dom.btnnew=$("<button/>").html("新建").on("click",function(){_frame.modal.show(_frame.app_main.page.ships.gen_form_new_ship_type_collection(function(e,n){a.add(n),_frame.modal.hide()}),"新建舰种集合")}).appendTo(a.dom.new_container),a.dom.ship_type_collections=$('<div class="ship_type_collections"/>').appendTo(e),_db.ship_type_collections.find({}).sort({id:1}).exec(function(e,n){if(!e&&n&&n.length)for(var t in n)a.add(n[t])})}},_frame.app_main.page.items={},_frame.app_main.page.items.section={},_frame.app_main.page.items.show_item_form=function(d){function _input(name,label,suffix,options){return _frame.app_main.page.ships.gen_form_line("text",name,label,eval("d."+name)||"",suffix,options)}function _stat(e,a){var n=$("<p/>"),t="_input_g"+_g.inputIndex;switch(_g.inputIndex++,e){case"dismantle":$('<label for="'+t+'"/>').html("燃料").appendTo(n);_frame.app_main.page.ships.gen_input("number","dismantle",t,d.dismantle[0]).appendTo(n);t="_input_g"+_g.inputIndex,_g.inputIndex++,$('<label for="'+t+'"/>').html("弹药").appendTo(n),_frame.app_main.page.ships.gen_input("number","dismantle",t,d.dismantle[1]).appendTo(n),t="_input_g"+_g.inputIndex,_g.inputIndex++,$('<label for="'+t+'"/>').html("钢材").appendTo(n),_frame.app_main.page.ships.gen_input("number","dismantle",t,d.dismantle[2]).appendTo(n),t="_input_g"+_g.inputIndex,_g.inputIndex++,$('<label for="'+t+'"/>').html("铝土").appendTo(n),_frame.app_main.page.ships.gen_input("number","dismantle",t,d.dismantle[3]).appendTo(n);break;case"range":var i=d.stat[e];$('<label for="'+t+'"/>').html(a).appendTo(n);_frame.app_main.page.ships.gen_input("select","stat."+e,t,[{value:"1",title:"短"},{value:"2",title:"中"},{value:"3",title:"长"},{value:"4",title:"超长"}],{"default":i}).appendTo(n);$('<label for="'+t+'"/>').html("当前值: "+i).appendTo(n);break;default:var i=d.stat[e];$('<label for="'+t+'"/>').html(a).appendTo(n);_frame.app_main.page.ships.gen_input("number","stat."+e,t,i).appendTo(n)}return n}function _upgrade_to(e,a,n){var t=$("<p/>"),i="_input_g"+_g.inputIndex;return _g.inputIndex++,$('<label for="'+i+'"/>').html("可升级为").appendTo(t),_comp.selector_equipment("upgrade_to","",a).appendTo(t),i="_input_g"+_g.inputIndex,_g.inputIndex++,$('<label for="'+i+'"/>').html("初始星级").appendTo(t),_frame.app_main.page.ships.gen_input("number","upgrade_to_star",i,n).appendTo(t),$('<button type="button" class="delete"/>').html("&times;").on("click",function(){t.remove()}).appendTo(t),t}function _improvement(e){function a(e){function a(e){var a=$("<p/>").appendTo(t);return _comp.selector_ship(null,null,e).appendTo(a),$('<button type="button" class="delete"/>').html("&times;").on("click",function(){a.remove()}).appendTo(a),a}var t=$("<div/>").appendTo(i);$("<h6/>").html("星期").appendTo(t);for(var p=0;7>p;p++){var s;switch(p){case 0:s="日";break;case 1:s="一";break;case 2:s="二";break;case 3:s="三";break;case 4:s="四";break;case 5:s="五";break;case 6:s="六"}n=_g.newInputIndex(),$('<input type="checkbox" id="'+n+'"/>').prop("checked",e[0][p]).appendTo(t),$('<label for="'+n+'"/>').html(s).appendTo(t)}$("<h6/>").html("秘书舰").appendTo(t);for(var o=0;o<(e[1]?e[1].length:0);o++)a(e[1]?e[1][o]:!1).appendTo(t);var r=$('<button class="add" type="button"/>').on("click",function(){a().insertBefore(r)}).html("+ 秘书舰").appendTo(t);return $('<button type="button" class="delete"/>').html("&times;").on("click",function(){t.remove()}).appendTo(t),t}e=e||{upgrade:!1,resource:[[0,0,0,0],[0,0,0,0,null,0],[0,0,0,0,null,0],[0,0,0,0,null,0]],req:[[[!1,!1,!1,!1,!1,!1,!1],!1]]};var n,t,i=$('<div class="improvement"/>');t=$('<p class="upgrade"/>').appendTo(i),$("<label/>").html("可升级为").appendTo(t),_comp.selector_equipment("","",e.upgrade?e.upgrade[0]:null).appendTo(t),n=_g.newInputIndex(),$('<label for="'+n+'"/>').html("初始星级").appendTo(t),_frame.app_main.page.ships.gen_input("number","",n,e.upgrade?e.upgrade[1]:0).appendTo(t);for(var p=$('<div class="require"/>').html("<h5>星期 & 秘书舰</h5>").appendTo(i),s=0;s<e.req.length;s++)a(e.req[s]).appendTo(p);var o=$('<button class="add" type="button"/>').on("click",function(){a([[!1,!1,!1,!1,!1,!1,!1],!1]).insertBefore(o)}).html("+ 要求").appendTo(p);t=$('<p class="resource resource-all"/>').append($("<h5/>").html("资源消费")).appendTo(i),n=_g.newInputIndex(),$('<label for="'+n+'"/>').html("燃料").appendTo(t),_frame.app_main.page.ships.gen_input("number","",n,e.resource[0][0]).appendTo(t),n=_g.newInputIndex(),$('<label for="'+n+'"/>').html("弹药").appendTo(t),_frame.app_main.page.ships.gen_input("number","",n,e.resource[0][1]).appendTo(t),n=_g.newInputIndex(),$('<label for="'+n+'"/>').html("钢材").appendTo(t),_frame.app_main.page.ships.gen_input("number","",n,e.resource[0][2]).appendTo(t),n=_g.newInputIndex(),$('<label for="'+n+'"/>').html("铝土").appendTo(t),_frame.app_main.page.ships.gen_input("number","",n,e.resource[0][3]).appendTo(t);for(var s=1;4>s;s++){var r;switch(s){case 1:r="+0 ~ +5";break;case 2:r="+6 ~ MAX";break;case 3:r="升级"}t=$('<p class="resource resource-mat"/>').append($("<h5/>").html(r)).appendTo(i),n=_g.newInputIndex(),$('<label for="'+n+'"/>').html("开发").appendTo(t),_frame.app_main.page.ships.gen_input("number","",n,e.resource[s][0]).appendTo(t),n=_g.newInputIndex(),$('<label for="'+n+'"/>').html("确").appendTo(t),_frame.app_main.page.ships.gen_input("number","",n,e.resource[s][1]).appendTo(t),n=_g.newInputIndex(),$('<label for="'+n+'"/>').html("改修").appendTo(t),_frame.app_main.page.ships.gen_input("number","",n,e.resource[s][2]).appendTo(t),n=_g.newInputIndex(),$('<label for="'+n+'"/>').html("确").appendTo(t),_frame.app_main.page.ships.gen_input("number","",n,e.resource[s][3]).appendTo(t),$("<label/>").html("装备").appendTo(t),_comp.selector_equipment("","",e.resource[s][4]).appendTo(t),n=_g.newInputIndex(),$('<label for="'+n+'"/>').html("量").appendTo(t),_frame.app_main.page.ships.gen_input("number","",n,e.resource[s][5]).appendTo(t)}return $('<button type="button" class="delete"/>').html("&times;").on("click",function(){i.remove()}).appendTo(i),i}console.log(d),d.default_equipped_on=d.default_equipped_on||[];
var form=$('<form class="iteminfo new"/>'),base=$('<div class="base"/>').appendTo(form),details=$('<div class="tabview"/>').appendTo(form),_id=d._id?$('<input type="hidden"/>').val(d._id):null,details_stat=$('<section data-tabname="属性"/>').appendTo(details),details_craft=$('<section data-tabname="开发&改修"/>').appendTo(details),details_equipped=$('<section data-tabname="初装舰娘"/>').appendTo(details),base_image=$('<div class="image"/>').css("background-image","url(../pics/items/"+d.id+"/card.png)").appendTo(base);_input("id","ID",null,{required:!0}).appendTo(base),_input("rarity","稀有度",null,{required:!0}).appendTo(base);var base_type=_frame.app_main.page.ships.gen_form_line("select","type","类型",[]).appendTo(base);_db.item_types.find({}).sort({id:1}).exec(function(e,a){if(!e){var n=[],t=base_type.find("select");for(var i in a)n.push({value:a[i].id,title:a[i].name.zh_cn});_frame.app_main.page.ships.gen_input("select",t.attr("name"),t.attr("id"),n,{"default":d.type,"new":function(e){console.log("NEW SHIP TYPE",e)}}).insertBefore(t),t.remove()}});var h4=$("<h4/>").html("装备名").appendTo(base),checkbox_id="_input_g"+_g.inputIndex;_g.inputIndex++,_input("name.ja_jp","<small>日</small>").appendTo(base),_input("name.ja_kana","<small>日假名</small>").appendTo(base),_input("name.ja_romaji","<small>罗马音</small>").appendTo(base),_input("name.zh_cn","<small>简中</small>").appendTo(base),_stat("fire","火力").appendTo(details_stat),_stat("torpedo","雷装").appendTo(details_stat),_stat("bomb","爆装").appendTo(details_stat),_stat("asw","对潜").appendTo(details_stat),_stat("aa","对空").appendTo(details_stat),_stat("armor","装甲").appendTo(details_stat),_stat("evasion","回避").appendTo(details_stat),_stat("hit","命中").appendTo(details_stat),_stat("los","索敌").appendTo(details_stat),_stat("range","射程").appendTo(details_stat),$("<h4/>").html("废弃资源").appendTo(details_stat),_stat("dismantle").appendTo(details_stat);var line=$("<p/>").appendTo(details_craft),id="_input_g"+_g.inputIndex;_g.inputIndex++,_frame.app_main.page.ships.gen_input("checkbox","craftable",id,d.craftable||!1).appendTo(line),$('<label for="'+id+'"/>').html("可开发").appendTo(line),$("<h4/>").html("改修").appendTo(details_craft);for(var i=0;i<(d.improvement?d.improvement.length:0);i++)_improvement(d.improvement?d.improvement[i]:null).appendTo(details_craft);var btn_add_improvement=$('<button class="add" type="button"/>').on("click",function(){_improvement().insertBefore(btn_add_improvement)}).html("+ 改修项目").appendTo(details_craft),ships_equipped={};_db.ships.find({equip:d.id},function(e,a){for(var n in a)"undefined"==typeof ships_equipped[a[n].series]&&(ships_equipped[a[n].series]=[]),ships_equipped[a[n].series].push(a[n]);for(var n in ships_equipped){ships_equipped[n].sort(function(e,a){return e.name.suffix-a.name.suffix});for(var t in ships_equipped[n])d.default_equipped_on.push(ships_equipped[n][t].id),$("<div/>").html('<img src="../pics/ships/'+ships_equipped[n][t].id+'/0.png"/>['+ships_equipped[n][t].id+"] "+(ships_equipped[n][t].name.zh_cn||ships_equipped[n][t].name.ja_jp)+(ships_equipped[n][t].name.suffix?"・"+_g.data.ship_namesuffix[ships_equipped[n][t].name.suffix].zh_cn:"")).appendTo(details_equipped)}});var line=$('<p class="actions"/>').appendTo(form);$('<button type="submit"/>').html(d._id?"编辑":"入库").appendTo(line),form.on("submit",function(e){function a(){_id?(n.time_modified=_g.timeNow(),console.log("EDIT",n),_db.items.update({_id:d._id},{$set:n},{},function(e,a){console.log("UPDATE COMPLETE",a,n),n._id=d._id;var t=_frame.app_main.page.items.section["已入库"].dom.section.find('[data-itemid="'+n.id+'"]');_frame.app_main.page.items.section["已入库"].dom.section.data("itemlist").append_item(n).insertBefore(t),t.remove(),_frame.modal.hide()})):(n.time_created=_g.timeNow(),node.fs.unlink(_g.path.fetched.items+"/"+n.id+".json",function(e){_db.items.insert(n,function(e,a){console.log("INSERT COMPLETE",a);try{_frame.app_main.page.items.section["未入库"].dom.main.find('[data-itemid="'+n.id+'"]').remove()}catch(t){}_frame.app_main.page.items.section["已入库"].dom.section.data("itemlist").append_item(a),_frame.modal.hide()})}))}e.preventDefault();var n={},t=$(this);n=t.serializeObject(),delete n.default_equipped_on,n.craftable=n.craftable?!0:!1,n.improvable=!1,n.upgrade_to=null,n.improvement=!1,t.find(".improvement").each(function(e){n.improvable=!0,n.improvement||(n.improvement=[]);var a={upgrade:!1,req:[],resource:[[],[],[],[]]},t=$(this),i=t.find(".upgrade"),p=parseInt(i.find("select").val());if(!isNaN(p)){n.upgrade_to||(n.upgrade_to=[]);var s=parseInt(t.find('input[type="number"]').val())||0;a.upgrade=[p,s],n.upgrade_to.push([p,s])}t.find(".require>div").each(function(e){var n=[[],!1];$(this).find('input[type="checkbox"]').each(function(e){n[0][e]=$(this).prop("checked")}),$(this).find("select").each(function(e){n[1]||(n[1]=[]);var a=$(this).val();a&&n[1].push(parseInt(a))}),a.req.push(n)}),t.find(".resource").each(function(e){$(this).find("input, select").each(function(n){a.resource[e].push(parseInt($(this).val())||0)})}),n.improvement.push(a)}),console.log(n),a()}),_frame.modal.show(form,d.name.ja_jp||"未入库装备",{classname:"infos_form"})},_frame.app_main.page.items.field_input_text=function(e,a,n,t){var i=$("<p/>"),p=$("<label/>").appendTo(i);return $("<span/>").html(a).appendTo(p),$('<input type="text" required name="'+e+'" />').val(n).appendTo(p),t&&$("<span/>").html(t).appendTo(p),i},_frame.app_main.page.items.field_select_items=_comp.selector_equipment,_frame.app_main.page.items.field_actions=function(e,a){var n=$('<p class="actions"/>');return $('<button type="submit"/>').html(e||"提交").appendTo(n),a&&$('<button type="button"/>').html("删除").on("click",function(){a()}).appendTo(n),n},_frame.app_main.page.items.gen_form_new_item_type=function(e,a,n){e=e||function(){},is_edit=a;var t=_frame.app_main.page.items,i=$('<form class="itemform item_type"/>').on("submit",function(n){n.preventDefault();var t=$(this).serializeObject();"object"!=typeof t.equipable_on_type&&"undefined"!=typeof t.equipable_on_type&&(t.equipable_on_type=[t.equipable_on_type]),t.equipable_on_type=t.equipable_on_type||[],is_edit?_db.item_types.update({_id:a._id},{$set:t},{},function(a,n){e(t),_frame.modal.hide()}):_db.item_types.count({},function(a,n){t.id=parseInt(n)+1,_db.item_types.insert(t,e)})}),p=$("<div/>").appendTo(i);t.field_input_text("name.ja_jp","日",is_edit?a.name.ja_jp:null).appendTo(p),t.field_input_text("name.zh_cn","简中",is_edit?a.name.zh_cn:null).appendTo(p),$("<h4/>").html("图标").appendTo(p);var s="./app/assets/images/itemicon/transparent",o=$('<div class="icons"/>').appendTo(p),r=[];node.fs.readdir(s,function(e,n){for(var t in n)r.push(n[t]);r.sort(function(e,a){return parseInt(e.split(".")[0])-parseInt(a.split(".")[0])});for(var t in r){var i="_input_g"+_g.inputIndex,p=r[t].split(".")[0],d=$('<span class="unit"/>').appendTo(o);_g.inputIndex++,$('<input type="radio" name="icon" value="'+p+'" id="'+i+'"/>').prop("checked",a&&a.icon==p).appendTo(d),$('<label for="'+i+'"/>').css("background-image","url(../"+s+"/"+r[t]+")").appendTo(d)}}),$("<h4/>").html("可装备舰种").appendTo(p);var d=_p.el.flexgrid.create().addClass("ship_types").appendTo(p),_=is_edit?a.equipable_on_type:[];return _db.ship_types.find({}).sort({id:1}).exec(function(e,a){for(var n in a){var t=parseInt(a[n].id),i="_input_g"+_g.inputIndex,p=$('<div class="unit"/>');d.appendDOM(p),_g.inputIndex++,$('<input type="checkbox" name="equipable_on_type" value="'+t+'" id="'+i+'">').prop("checked",$.inArray(t,_)>-1).appendTo(p),$('<label for="'+i+'"/>').html(a[n].full_zh).appendTo(p)}}),t.field_actions(is_edit?"更新":null,n?function(){_db.item_types.remove({_id:a._id},{},function(e,a){n(),_frame.modal.hide()})}:null).appendTo(i),i},_frame.app_main.page.items.gen_form_new_item_type_collection=function(e,a,n){e=e||function(){},is_edit=a;var t=_frame.app_main.page.items,i=$('<form class="itemform item_type_collection"/>').on("submit",function(n){n.preventDefault();var t=$(this).serializeObject();"object"!=typeof t.types&&"undefined"!=typeof t.types&&(t.types=[t.types]),t.types=t.types||[],is_edit?_db.item_type_collections.update({_id:a._id},{$set:t},{},function(a,n){e(t),_frame.modal.hide()}):_db.item_type_collections.count({},function(a,n){t.id=parseInt(n)+1,_db.item_type_collections.insert(t,e)})}),p=$("<div/>").appendTo(i);t.field_input_text("name.zh_cn","简中",is_edit?a.name.zh_cn:null).appendTo(p),$("<h4/>").html("图标").appendTo(p);var s="./app/assets/images/itemcollection",o=$('<div class="icons"/>').appendTo(p),r=[];return node.fs.readdir(s,function(e,n){for(var t in n)r.push(n[t]);r.sort(function(e,a){return parseInt(e.split(".")[0])-parseInt(a.split(".")[0])});for(var t in r){var i="_input_g"+_g.inputIndex,p=r[t].split(".")[0],d=$('<span class="unit"/>').appendTo(o);_g.inputIndex++,$('<input type="radio" name="icon" value="'+p+'" id="'+i+'"/>').prop("checked",a&&a.icon==p).appendTo(d),$('<label for="'+i+'"/>').css("background-image","url(../"+s+"/"+r[t]+")").appendTo(d)}}),$("<h4/>").html("装备类型").appendTo(p),_form.create_item_types("types",is_edit?a.types:[]).appendTo(p),t.field_actions(is_edit?"更新":null,n?function(){_db.item_type_collections.remove({_id:a._id},{},function(e,a){n(),_frame.modal.hide()})}:null).appendTo(i),i},_frame.app_main.page.items.init=function(e){e.find("section").on({"tabview-show":function(){var e=$(this),a=e.data("tabname");_frame.app_main.page.items.section[a]||(_frame.app_main.page.items.section[a]={});var n=_frame.app_main.page.items.section[a];switch(!n.is_init&&n.init&&(n.init(e),n.is_init=!0),a){case"未入库":}}})},_frame.app_main.page.items.section["已入库"]={dom:{},init:function(e){_frame.app_main.page.items.section["已入库"].dom.section=e}},_frame.app_main.page.items.section["未入库"]={dom:{},data:{},data_id:[],init_list:function(e){function a(e){var a={id:e.id,name:{ja_jp:e.name},type:null,rarity:0==e.rarity||1==e.rarity?parseInt(e.rarity)+1:parseInt(e.rarity),stat:{fire:e.fire,torpedo:e.torpedo,bomb:e.bomb,asw:e.ass,aa:e.aac,armor:e.armor,evasion:e.evasion,hit:e.hit,los:e.seek,range:e.range},dismantle:JSON.parse(e.dismantle),default_equipped_on:[]};return a}var n=_frame.app_main.page.items.section["未入库"],t=_frame.app_main.page.items.section["未入库"].data_id[e],i=_frame.app_main.page.items.section["未入库"].data[t];n.dom.list.appendDOM($('<button class="unit newitem" data-itemid="'+t+'" data-itemmodal="false"/>').append($('<span><img src="../pics/items/'+t+'/card.png" alt="'+i.name+'"/></span>')).on("click",function(e,n){_frame.app_main.page.items.show_item_form($.extend(!0,a(i),n||{}))})),e>=_frame.app_main.page.items.section["未入库"].data_id.length-1?n.dom.new_container.html("All "+_frame.app_main.page.items.section["未入库"].data_id.length+" items loaded."):(e++,n.dom.new_container.html(e+" / "+_frame.app_main.page.items.section["未入库"].data_id.length+" items loaded."),setTimeout(function(){_frame.app_main.page.items.section["未入库"].init_list(e)},10))},init:function(section){var self=_frame.app_main.page.items.section["未入库"];self.dom.new_container=$('<div class="new_container"/>').html("Loading...").appendTo(section),self.dom.main=$('<div class="main"/>').appendTo(section),self.dom.list=_p.el.flexgrid.create().addClass("newitems").appendTo(self.dom.main),_db.items.find({}).sort({id:1}).exec(function(e,a){if(!e&&a&&a.length)for(var n in a)self.add(a[n])}),node.fs.readdir(_g.path.fetched.items,function(err,files){for(var i in files)node.fs.readFile(_g.path.fetched.items+"/"+files[i],"utf8",function(err,data){if(err)throw err;eval("var _data = "+data),_frame.app_main.page.items.section["未入库"].data[_data.id]=_data,_frame.app_main.page.items.section["未入库"].data_id.push(_data.id),_frame.app_main.page.items.section["未入库"].data_id.length>=files.length&&(_frame.app_main.page.items.section["未入库"].data_id.sort(function(e,a){return e-a}),_frame.app_main.page.items.section["未入库"].init_list(0))});!err&&files&&files.length||$("<p/>").html("暂无内容...<br />请初始化数据").appendTo(self.dom.list)})}},_frame.app_main.page.items.section["类型"]={dom:{},titlebtn:function(e){var a=_frame.app_main.page.items.section["类型"],n=$('<button class="unit item_type"/>').html('<span style="background-image: url(../app/assets/images/itemicon/transparent/'+e.icon+'.png)"></span>'+e.name.zh_cn).on("click",function(){_frame.modal.show(_frame.app_main.page.items.gen_form_new_item_type(function(e){a.titlebtn(e).insertAfter(n),n.remove()},e,function(){n.remove()}),"编辑类型")});return n},add:function(e){var a=_frame.app_main.page.items.section["类型"];a.dom.list.appendDOM(a.titlebtn(e))},init:function(e){var a=_frame.app_main.page.items.section["类型"];a.dom.new_container=$('<div class="new_container"/>').appendTo(e),a.dom.btnnew=$("<button/>").html("新建").on("click",function(){_frame.modal.show(_frame.app_main.page.items.gen_form_new_item_type(function(e,n){a.add(n),_frame.modal.hide()}),"新建类型")}).appendTo(a.dom.new_container),a.dom.main=$('<div class="main"/>').appendTo(e),a.dom.list=_p.el.flexgrid.create().addClass("item_types").appendTo(a.dom.main),_db.item_types.find({}).sort({id:1}).exec(function(e,n){if(!e&&n&&n.length)for(var t in n)a.add(n[t])})}},_frame.app_main.page.items.section["类型集合"]={dom:{},titlebtn:function(e){var a=_frame.app_main.page.items.section["类型集合"],n=$('<button class="item_type_collection"/>').html(e.name.zh_cn).on("click",function(){_frame.modal.show(_frame.app_main.page.items.gen_form_new_item_type_collection(function(e){a.titlebtn(e).insertAfter(n),n.remove()},e,function(){n.remove()}),"编辑类型集合")});return n},add:function(e){var a=_frame.app_main.page.items.section["类型集合"];a.titlebtn(e).appendTo(a.dom.main)},init:function(e){var a=_frame.app_main.page.items.section["类型集合"];a.dom.new_container=$('<div class="new_container"/>').appendTo(e),a.dom.btnnew=$("<button/>").html("新建").on("click",function(){_frame.modal.show(_frame.app_main.page.items.gen_form_new_item_type_collection(function(e,n){a.add(n),_frame.modal.hide()}),"新建类型集合")}).appendTo(a.dom.new_container),a.dom.main=$('<div class="main"/>').appendTo(e),_db.item_type_collections.find({}).sort({id:1}).exec(function(e,n){if(!e&&n&&n.length)for(var t in n)a.add(n[t])})}},_frame.app_main.page.items.section["新建"]={dom:{},init:function(e){var a=_frame.app_main.page.items.section["新建"];a.dom.section=e,a.dom.form=$("<form/>").on("submit",function(e){e.preventDefault();var n=a.dom.form.serializeObject(),t={name:{},stat:{},dismantle:[0,0,0,0]};n.id&&(t.id=n.id),_frame.app_main.page.items.show_item_form(t)}).data({item_data:{}}).appendTo(e);var n="_input_g"+_g.inputIndex;_g.inputIndex++,$("<p/>").append($('<label for="'+n+'"/>').html("ID")).append($('<input id="'+n+'" type="number" name="id"/>')).appendTo(a.dom.form),$('<p class="actions"/>').append($('<button type="submit"/>').html("新建")).appendTo(a.dom.form)}},_frame.app_main.page.entities={},_frame.app_main.page.entities.section={},_frame.app_main.page.entities.gen_form_new_entity=function(e,a,n){e=e||function(){};var t=(_frame.app_main.page.entities,$('<form class="new_entity"/>').on("submit",function(n){n.preventDefault();var t=$(this).serializeObject();t.links=[],t.link_name=t.link_name.push?t.link_name:[t.link_name],t.link_url=t.link_url.push?t.link_url:[t.link_url];for(var i in t.link_name)t.links[i]={name:t.link_name[i],url:t.link_url[i]};t.link_name=null,t.link_url=null,delete t.link_name,delete t.link_url,a?_db.entities.update({_id:a._id},{$set:t},{},function(a,n){e(t),_frame.modal.hide()}):_db.entities.count({},function(a,n){t.id=parseInt(n)+1,_db.entities.insert(t,e)})}));return $("<h4/>").html("名称").appendTo(t),_frame.app_main.page.ships.section["舰种&舰级"].field_input_text("name.ja_jp","日",a?a.name.ja_jp:null).appendTo(t),_frame.app_main.page.ships.section["舰种&舰级"].field_input_text("name.zh_cn","简中",a?a.name.zh_cn:null).appendTo(t),_form.section_order("链接",function(e,a){var n=$("<p/>"),t="_input_g"+_g.inputIndex,i=e.name||null,p=e.url||null;return _g.inputIndex++,$('<label for="'+t+'"/>').appendTo(n),_frame.app_main.page.ships.gen_input("text","link_name",t,i,{notRequired:!0}).appendTo(n),t="_input_g"+_g.inputIndex,_g.inputIndex++,$('<label for="'+t+'"/>').html("URL").appendTo(n),_frame.app_main.page.ships.gen_input("text","link_url",t,p,{notRequired:!0}).appendTo(n),n},$.extend(!0,[{name:"Twitter",url:null}],a?a.links:[])).appendTo(t),_frame.app_main.page.ships.section["舰种&舰级"].field_actions(a?"更新":null,n?function(){_db.entities.remove({_id:a._id},{},function(e,a){n(),_frame.modal.hide()})}:null).appendTo(t),t},_frame.app_main.page.entities.init=function(e){e.find("section").on({"tabview-show":function(){var e=$(this),a=e.data("tabname");_frame.app_main.page.entities.section[a]||(_frame.app_main.page.entities.section[a]={});var n=_frame.app_main.page.entities.section[a];!n.is_init&&n.init&&(n.init(e),n.is_init=!0)}})},_frame.app_main.page.entities.section["人物&组织"]={dom:{},get_content:function(e){return"<strong>"+e.name.zh_cn+"</strong><small>"+e.name.ja_jp+"</small>"},get_titlebtn:function(e){var a=_frame.app_main.page.entities.section["人物&组织"],n=$('<button class="ship_suffix"/>').html(a.get_content(e)).on("click",function(){_frame.modal.show(_frame.app_main.page.entities.gen_form_new_entity(function(e){n.html(a.get_content(e))},e,function(){n.remove()}),"编辑实体")});return n},added_entity:function(e){var a=_frame.app_main.page.entities.section["人物&组织"];a.get_titlebtn(e).appendTo(a.dom.section)},init:function(e){var a=_frame.app_main.page.entities.section["人物&组织"];a.dom.new_container=$('<div class="new_container"/>').appendTo(e),a.dom.btnnew=$("<button/>").html("新建").on("click",function(){_frame.modal.show(_frame.app_main.page.entities.gen_form_new_entity(function(e,n){a.added_entity(n),_frame.modal.hide()}),"新建实体")}).appendTo(a.dom.new_container),a.dom.section=$('<div class="main"/>').appendTo(e),_db.entities.find({}).sort({id:1}).exec(function(e,n){if(!e)for(var t in n)a.added_entity(n[t])})}},_frame.app_main.page.update={},_frame.app_main.page.update.section={},_frame.app_main.page.update.field_input_text=function(e,a,n,t){var i=$("<p/>"),p=$("<label/>").appendTo(i);return $("<span/>").html(a).appendTo(p),$('<input type="text" required name="'+e+'" />').val(n).appendTo(p),t&&$("<span/>").html(t).appendTo(p),i},_frame.app_main.page.update.field_input_date=function(e,a,n,t){var i=$("<p/>"),p=$("<label/>").appendTo(i);return $("<span/>").html(a).appendTo(p),$('<input type="date" name="'+e+'" />').val(n).appendTo(p),t&&$("<span/>").html(t).appendTo(p),i},_frame.app_main.page.update.field_input_checkbox=function(e,a,n,t){var i=$("<p/>"),p=$("<label/>").appendTo(i);return $("<span/>").html(a).appendTo(p),$('<input type="checkbox" name="'+e+'" />').prop("checked",n?!0:!1).appendTo(p),t&&$("<span/>").html(t).appendTo(p),i},_frame.app_main.page.update.field_input_textarea=function(e,a,n,t){var i=$("<p/>"),p=$("<label/>").appendTo(i);return $("<span/>").html(a).appendTo(p),$('<textarea required name="'+e+'" />').val(n).attr({cols:60,rows:20}).appendTo(p),t&&$("<span/>").html(t).appendTo(p),i},_frame.app_main.page.update.field_actions=function(e,a){var n=$('<p class="actions"/>');return $('<button type="submit"/>').html(e||"提交").appendTo(n),a&&$('<button type="button"/>').html("删除").on("click",function(){a()}).appendTo(n),n},_frame.app_main.page.update.gen_form_new_journal=function(e,a,n){e=e||function(){},is_edit=a;var t=this,i=$('<form class="update_journal"/>').on("submit",function(n){n.preventDefault();var t=$(this).serializeObject();t.version=node.semver.clean(t.version),console.log(t),is_edit?_db.updates.update({_id:a._id},{$set:t},{},function(a,n){e(t),_frame.modal.hide()}):_db.updates.count({},function(a,n){t.id=parseInt(n)+1,_db.updates.insert(t,e)})}),p=$("<div/>").appendTo(i);return _frame.app_main.page.ships.gen_input("select","type",null,["app","app-db","pics"],{"default":is_edit?a.type:null}).insertBefore(p),t.field_input_text("version","版本号",is_edit?a.version:null).appendTo(p),t.field_input_date("date","更新日",is_edit?a.date:null).appendTo(p),t.field_input_checkbox("hotfix",null,is_edit?a.hotfix:!1,"HOTFIX ?").appendTo(p),t.field_input_textarea("journal","更新日志",is_edit?a.journal:null).appendTo(p),t.field_actions(is_edit?"更新":null,n?function(){_db.updates.remove({_id:a._id},{},function(e,a){n(),_frame.modal.hide()})}:null).appendTo(i),i},_frame.app_main.page.update.init=function(e){e.find("section").on({"tabview-show":function(){var e=$(this),a=e.data("tabname");_frame.app_main.page.update.section[a]||(_frame.app_main.page.update.section[a]={});var n=_frame.app_main.page.update.section[a];!n.is_init&&n.init&&(n.init(e),n.is_init=!0)}})},_frame.app_main.page.update.section["更新日志"]={dom:{},titlebtn:function(e){var a=this,n=$('<button class="unit"/>').html("<strong>"+e.type.toUpperCase()+"/"+e.version+"</strong><br/><small><em>"+e.date+"</em></small>").on("click",function(){_frame.modal.show(_frame.app_main.page.update.gen_form_new_journal(function(e){a.titlebtn(e).insertAfter(n),n.remove()},e,function(){n.remove()}),"编辑更新日志")});return n},add:function(e){var a=this;a.dom.list.appendDOM(a.titlebtn(e))},init:function(e){var a=this;a.dom.new_container=$('<div class="new_container"/>').appendTo(e),a.dom.btnnew=$("<button/>").html("新建").on("click",function(){_frame.modal.show(_frame.app_main.page.update.gen_form_new_journal(function(e,n){a.add(n),_frame.modal.hide()}),"新建更新日志")}).appendTo(a.dom.new_container),a.dom.main=$('<div class="main"/>').appendTo(e),a.dom.list=_p.el.flexgrid.create().addClass("update_history").appendTo(a.dom.main),_db.updates.find({}).sort({date:-1}).exec(function(e,n){if(!e&&n&&n.length)for(var t in n)a.add(n[t])})}},_frame.app_main.page.gamedata={},_frame.app_main.page.gamedata.init=function(e){jf.readFile(node.path.join(_g.root,"/fetched_data/api_start2.json"),function(a,n){if(a)return!1;e.empty(),_frame.app_main.page.gamedata.tabview=$('<div class="tabview"/>').appendTo(e),_frame.app_main.page.gamedata.data=n.api_data,console.log(n);for(var t in n.api_data){var i=t.replace("api_mst_","");_frame.app_main.page.gamedata["init_"+i]&&_frame.app_main.page.gamedata["init_"+i](n.api_data[t])}_p.initDOM(e)})},_frame.app_main.page.gamedata.init_ship=function(e){var a=$('<section class="list" data-tabname="Ships"/>').appendTo(this.tabview),n={};for(var t in this.data.api_mst_shipgraph)n[this.data.api_mst_shipgraph[t].api_id]={filename:this.data.api_mst_shipgraph[t].api_filename,version:parseInt(this.data.api_mst_shipgraph[t].api_version)};console.log(n),$('<button type="button"/>').html("下载全部数据文件").on("click",function(){function e(e){console.log(e)}var a=Q.fcall(function(){}),t=node.path.join(_g.root,"/fetched_data/ships_raw/"),i=node.path.join(_g.root,"/fetched_data/ships_pic/"),p=node.path.join(t,"_.json"),s={};a.then(function(){var a=Q.defer();return node.mkdirp(t,function(n){n?(e("创建目录失败 "+t),a.reject(new Error(n))):(e("已确保目录 "+t),a.resolve())}),a.promise}).then(function(){var a=Q.defer();return node.mkdirp(i,function(n){n?(e("创建目录失败 "+i),a.reject(new Error(n))):(e("已确保目录 "+i),a.resolve())}),a.promise}).then(function(){var e=Q.defer();return jf.readFile(p,function(a,n){s=n||{},e.resolve()}),e.promise}).then(function(){e("开始遍历舰娘数据");var o=0,r=_frame.app_main.page.gamedata.data.api_mst_ship.length;return _frame.app_main.page.gamedata.data.api_mst_ship.forEach(function(d){!function(d){a=a.then(function(){var a=Q.defer(),_=node.url.parse("http://"+server_ip+"/kcs/resources/swf/ships/"+n[d.api_id].filename+".swf"),l=d.api_id+" - "+d.api_name+".swf",m=node.path.join(t,d.api_id+".swf"),u=node.path.join(t,l),f=node.path.join(i,"\\"+d.api_id),c=null,h=n[d.api_id].version||0,g=!1,v=null;try{var c=node.fs.lstatSync(u);c&&c.isFile()||(c=null)}catch(b){}return e("========== "+o+"/"+r+" =========="),e("    ["+d.api_id+"] "+d.api_name+" | 服务器版本: "+h+" | 本地版本: "+(s[d.api_id]||"无")),c&&h<=(s[d.api_id]||-1)?(g=!0,e("    本地版本已最新，跳过"),o++,a.resolve()):(e("    开始获取: "+_.href),s[d.api_id]=h,Q.fcall(function(){}).then(function(){var a=Q.defer();return request({uri:_,method:"GET",proxy:proxy}).on("error",function(e){a.reject(new Error(e))}).on("response",function(e){v=e.statusCode}).pipe(node.fs.createWriteStream(m).on("finish",function(){e("    文件已保存: "+d.api_id+" - "+d.api_name+".swf"),o++,jf.writeFile(p,s,function(n){n?a.reject(new Error(n)):(e("    版本文件已更新"),a.resolve())}),(200!=v||"なし"==d.api_name)&&(g=!0)})),a.promise}).then(function(){var a=Q.defer();if(g)a.resolve();else{e("    开始反编译 SWF");var n,t=node.require("child_process").exec;node.mkdirp.sync(f),e("    目录已确保 "+f),n=t("java -jar .\\app\\assets\\FFDec\\ffdec.jar -format image:png -export image "+f+" "+m,function(n,t,i){e("    stdout: "+t),e("    stderr: "+i),null!==n?(e("    exec error: "+n),a.reject(new Error(n))):(e("    SWF 反编译完成"),a.resolve())})}return a.promise}).then(function(){var e=Q.defer();return g?e.resolve():node.fs.readdir(f,function(a,n){a?e.reject(new Error(a)):e.resolve(n)}),e.promise}).then(function(a){var n=Q.fcall(function(){}),t=Q.defer(),i=0;return a=a||[],a=a.sort(function(e,a){var n=parseInt(e)||-999,t=parseInt(a)||-999;return n-t}),a.length?a.forEach(function(p){!function(i,p){n=n.then(function(){var n=Q.defer(),s=node.path.parse(i),o=Math.floor(parseInt(s.name)/2)+s.ext.toLowerCase(),r=node.path.join(f,i);node.fs.lstatSync(r).isFile()?node.fs.rename(r,node.path.join(f,o),function(i){null!==i?n.reject(new Error(i)):(e("    反编译: "+o),n.resolve()),p>=a.length-1&&t.resolve()}):(n.resolve(),p>=a.length-1&&t.resolve())})}(p,i),i++}):t.resolve(),t.promise}).then(function(){var a=Q.defer();return node.fs.rename(m,u,function(n){null!==n?a.reject(new Error(n)):(e("    SWF 文件重命名为 "+l),a.resolve())}),a.promise})["catch"](function(n){e(n),a.reject(new Error(n))}).done(function(){a.resolve()})),a.promise})}(d)}),!0})["catch"](function(a){e(a)}).done(function(){e("ALL DONE")})}).appendTo(a),$('<button type="button"/>').html("更新舰娘数据库").on("click",function(){function e(e){console.log(e)}var a=Q.fcall(function(){});a.then(function(){var e=Q.defer();return _db.ships.find({},function(a,n){if(a)e.reject(a);else{var t={};for(var i in n)t[n[i].id]=n[i]._id;e.resolve(t)}}),e.promise}).then(function(n){e(n),e("开始遍历舰娘数据");var t=0,i=_frame.app_main.page.gamedata.data.api_mst_ship.length;return _frame.app_main.page.gamedata.data.api_mst_ship.forEach(function(p){!function(p){function s(n){n>=i&&a.fin(function(){e("遍历舰娘数据完成")})}a=a.then(function(){var a=Q.defer();if(n[p.api_id]){e("    ["+p.api_id+"] "+p.api_name+" 开始处理"),t++;var i={};i.no=p.api_sortno,i.buildtime=p.api_buildtime,i["lines.start"]=p.api_getmes,i.rare=p.api_backs,i["stat.fire"]=p.api_houg[0],i["stat.fire_max"]=p.api_houg[1],i["stat.torpedo"]=p.api_raig[0],i["stat.torpedo_max"]=p.api_raig[1],i["stat.aa"]=p.api_tyku[0],i["stat.aa_max"]=p.api_tyku[1],i["stat.hp"]=p.api_taik[0],i["stat.hp_max"]=p.api_taik[1],i["stat.armor"]=p.api_souk[0],i["stat.armor_max"]=p.api_souk[1],i["stat.speed"]=p.api_soku,i["stat.range"]=p.api_leng,i["stat.luck"]=p.api_luck[0],i["stat.luck_max"]=p.api_luck[1],i["consum.fuel"]=p.api_fuel_max,i["consum.ammo"]=p.api_bull_max;var o=0;for(i.slot=[];o<(parseInt(p.api_slot_num)||0);)i.slot.push(p.api_maxeq[o]||0),o++;i["remodel_cost.fuel"]=p.api_afterfuel,i["remodel_cost.ammo"]=p.api_afterbull,i.scrap=p.api_broken,i.modernization=p.api_powup,i.time_modified=_g.timeNow(),e(i),_db.ships.update({_id:n[p.api_id]},{$set:i},function(){a.resolve(),s(t)})}else e("    ["+p.api_id+"] "+p.api_name+" 不存在于数据库，跳过"),t++,a.resolve(),s(t);return a.promise})}(p)}),!0})["catch"](function(a){e(a)}).done(function(){e("ALL DONE")})}).appendTo(a)},_frame.app_main.page.gamedata.init_slotitem=function(e){var a=$('<section class="list" data-tabname="Equipments"/>').appendTo(this.tabview);for(var n in e)!function(e){var n=$("<section/>").appendTo(a);$('<input type="checkbox" id="rawdata_slotitem_'+e.api_id+'"/>').appendTo(n),$('<label for="rawdata_slotitem_'+e.api_id+'"/>').html("[#"+e.api_id+"] "+e.api_name).appendTo(n);_db.items.find({id:e.api_id},function(a,t){(a||!t.length)&&(n.addClass("new"),$("<button/>").on("click",function(){_frame.app_main.page.items.show_item_form({id:e.api_id,rarity:e.api_rare,name:{ja_jp:e.api_name},stat:{fire:e.api_houg,torpedo:e.api_raig,bomb:e.api_baku,asw:e.api_tais,aa:e.api_tyku,armor:e.api_souk,evasion:e.api_houk,hit:e.api_houm,los:e.api_saku,range:e.api_leng},dismantle:e.api_broken})}).html("录入").appendTo(n))})}(e[n])},_form.section_order=function(e,a,n){function t(){var e=p.children(".line").removeClass("first last");e.eq(0).addClass("first"),e.eq(-1).addClass("last")}function i(e,n){n=parseInt(n||0);var i=a(e||{},n).addClass("line line-sortable").data({index:parseInt(n)}).insertBefore(o),p=$('<span class="btns"/>').appendTo(i);$('<button class="up" type="button"/>').html("&#8679").on("click",function(){var e=i.data("index");if(0>=e)return!1;var a=i.prev();i.insertBefore(a).data("index",e-1),a.data("index",e),t()}).appendTo(p),$('<button class="down" type="button"/>').html("&#8681").on("click",function(){var e=i.data("index");if(e>=s-1)return!1;var a=i.next();i.insertAfter(a).data("index",e+1),a.data("index",e),t()}).appendTo(p),$('<button class="delete" type="button"/>').html("&times;").on("click",function(){i.remove(),i.nextAll().each(function(){var e=$(this).data("index");$(this).data("index",e-1)}),s--,t()}).appendTo(p);return s++,t(),i}var p=$('<section class="form_section" data-name="'+e+'"/>').append($("<h4>"+e+"</h4>")),n=n||[],s=0,o=$('<button class="add" type="button"/>').on("click",function(){i({},s)}).html("添加"+e).appendTo(p);for(var r in n)i(n[r],r);return p},_form.create_equip_types=function(e,a){var n=_p.el.flexgrid.create().addClass("item_types");return a=a||[],_db.item_types.find({}).sort({id:1}).exec(function(t,i){for(var p in i){var s=parseInt(i[p].id),o="_input_g"+_g.inputIndex,r=$('<div class="unit"/>');n.appendDOM(r),_g.inputIndex++,$('<input type="checkbox" name="'+e+'" value="'+s+'" id="'+o+'">').prop("checked",$.inArray(s,a)>-1).appendTo(r),$('<label for="'+o+'"/>').html('<span style="background-image: url(../app/assets/images/itemicon/transparent/'+i[p].icon+'.png)"></span>'+i[p].name.zh_cn).appendTo(r)}}),n},_form.create_item_types=_form.create_equip_types,_comp.selector_equipment=function(e,a,n){var t=_frame.app_main.page.ships.gen_input("select",e||null,a||null,[]),i=[],p=[];return _db.item_types.find({}).sort({id:1}).exec(function(e,a){if(!e&&a&&a.length){for(var s in a)i[a[s].id]=[a[s].name.zh_cn,[]];_db.items.find({}).sort({type:1,rarity:1,id:1}).exec(function(e,a){for(var s in a)i[a[s].type][1].push({name:a[s].name.zh_cn,value:a[s].id});for(var s in i){p.push({name:"====="+i[s][0]+"=====",value:""});for(var o in i[s][1])p.push({name:i[s][1][o].name.zh_cn,value:i[s][1][o].id})}_frame.app_main.page.ships.gen_input("select_group",t.attr("name"),t.attr("id"),i,{"default":n}).insertBefore(t),t.remove()})}}),t},_comp.selector_ship=function(e,a,n){var t=_frame.app_main.page.ships.gen_input("select",e||null,a||null,[]),i=[];return _db.ships.find({}).sort({type:1,"class":1,class_no:1,time_created:1,"name.suffix":1}).exec(function(e,a){if(!e&&!_g.data.ship_id_by_type.length)for(var p in a)_g.data.ships[a[p].id]=a[p],"undefined"==typeof _g.data.ship_id_by_type[_g.ship_type_order_map[a[p].type]]&&(_g.data.ship_id_by_type[_g.ship_type_order_map[a[p].type]]=[]),_g.data.ship_id_by_type[_g.ship_type_order_map[a[p].type]].push(a[p].id);for(var p in _g.data.ship_id_by_type){if("object"==typeof _g.ship_type_order[p])var s=_g.data.ship_types[_g.ship_type_order[p][0]];else var s=_g.data.ship_types[_g.ship_type_order[p]];i[p]=[_g.ship_type_order_name[p].zh_cn+" ["+s.code+"]",[]];for(var o in _g.data.ship_id_by_type[p]){var r=_g.data.ships[_g.data.ship_id_by_type[p][o]];i[p][1].push({name:(r.name.zh_cn||r.name.ja_jp)+(r.name.suffix?"・"+_g.data.ship_namesuffix[r.name.suffix].zh_cn:""),value:_g.data.ship_id_by_type[p][o]})}}_frame.app_main.page.ships.gen_input("select_group",t.attr("name")||null,t.attr("id")||null,i,{"default":n||null}).insertBefore(t),t.remove()}),t},_p.el.shiplist={init_el:function(e){return e.data("shiplist")?!0:void e.data({
shiplist:new _shiplist(e)})},init:function(e,a){e=e||$("body"),a=a||e.find("section.shiplist"),a.each(function(){_p.el.shiplist.init_el($(this))})}};var _shiplist=function(e,a){this.dom={section:e},this.columns=["  ",["火力","fire"],["雷装","torpedo"],["对空","aa"],["对潜","asw"],["耐久","hp"],["装甲","armor"],["回避","evasion"],["搭载","carry"],["航速","speed"],["射程","range"],["索敌","los"],["运","luck"],["油耗","consum_fuel"],["弹耗","consum_ammo"]],this.init()};_shiplist.prototype.append_ship=function(e){function a(e){return 0==e||"0"==e?'<small class="zero">-</small>':e}var n=this,t=$('<tr data-shipid="'+e.id+'" data-shipedit="'+n.dom.section.hasClass("shiplist-edit")+'"/>').appendTo(this.dom.tbody),i=0,p=e.name.zh_cn+(e.name.suffix?"<small>"+_g.data.ship_namesuffix[e.name.suffix].zh_cn+"</small>":"");for(var s in e.carry)i+=e.carry[s];for(var s in n.columns)switch(n.columns[s][1]){case" ":$("<th/>").html('<img src="../pics/ships/'+e.id+'/0.png"/><strong>'+p+"</strong>").appendTo(t);break;case"fire":$('<td class="stat-fire"/>').html(a(e.stat.fire_max)).appendTo(t);break;case"torpedo":$('<td class="stat-torpedo"/>').html(a(e.stat.torpedo_max)).appendTo(t);break;case"aa":$('<td class="stat-aa"/>').html(a(e.stat.aa_max)).appendTo(t);break;case"asw":$('<td class="stat-asw"/>').html(a(e.stat.asw_max)).appendTo(t);break;case"hp":$('<td class="stat-hp"/>').html(a(e.stat.hp)).appendTo(t);break;case"armor":$('<td class="stat-armor"/>').html(a(e.stat.armor_max)).appendTo(t);break;case"evasion":$('<td class="stat-evasion"/>').html(a(e.stat.evasion_max)).appendTo(t);break;case"carry":$('<td class="stat-carry"/>').html(a(e.stat.carry)).appendTo(t);break;case"speed":$('<td class="stat-speed"/>').html(_g.getStatSpeed(e.stat.speed)).appendTo(t);break;case"range":$('<td class="stat-range"/>').html(_g.getStatRange(e.stat.range)).appendTo(t);break;case"los":$('<td class="stat-los"/>').html(a(e.stat.los_max)).appendTo(t);break;case"luck":$('<td class="stat-luck"/>').html(e.stat.luck+"<sup>"+e.stat.luck_max+"</sup>").appendTo(t);break;case"consum_fuel":$('<td class="stat-consum_fuel"/>').html(e.consum.fuel).appendTo(t);break;case"consum_ammo":$('<td class="stat-consum_ammo"/>').html(e.consum.ammo).appendTo(t)}return e.remodel_next&&_g.data.ships[e.remodel_next]&&_g.ship_type_order_map[e.type]==_g.ship_type_order_map[_g.data.ships[e.remodel_next].type]&&e.name.ja_jp==_g.data.ships[e.remodel_next].name.ja_jp&&t.addClass("premodeled"),t},_shiplist.prototype.append_ship_all=function(){var e=this;for(var a in _g.data.ship_id_by_type){if("object"==typeof _g.ship_type_order[a])var n=_g.data.ship_types[_g.ship_type_order[a][0]];else var n=_g.data.ship_types[_g.ship_type_order[a]];$('<tr class="typetitle"><th colspan="'+(e.columns.length+1)+'">'+_g.ship_type_order_name[a].zh_cn+"<small>["+n.code+"]</small></th></tr>").appendTo(this.dom.tbody);for(var t in _g.data.ship_id_by_type[a])e.append_ship(_g.data.ships[_g.data.ship_id_by_type[a][t]]);for(var i=0;9>i;)$('<tr class="empty"/>').appendTo(this.dom.tbody),i++}},_shiplist.prototype.append_option=function(e,a,n,t,i,p){function s(){switch(e){case"text":case"number":case"hidden":var n=$('<input type="'+e+'" name="'+a+'" id="'+r+'" />').val(t);break;case"select":var n=$('<select name="'+a+'" id="'+r+'" />'),i=$('<option value=""/>').html("").appendTo(n);for(var s in t){if("object"==typeof t[s])var o=$('<option value="'+("undefined"==typeof t[s].val?t[s].value:t[s].val)+'"/>').html(t[s].title||t[s].name).appendTo(n);else var o=$('<option value="'+t[s]+'"/>').html(t[s]).appendTo(n);"undefined"!=typeof p["default"]&&o.val()==p["default"]&&o.prop("selected",!0)}t&&t.length||(i.remove(),$('<option value=""/>').html("...").appendTo(n)),p["new"]&&($('<option value=""/>').html("==========").insertAfter(i),$('<option value="___new___"/>').html("+ 新建").insertAfter(i),n.on("change.___new___",function(){var e=$(this);"___new___"==e.val()&&(e.val(""),p["new"](n))}));break;case"checkbox":var n=$('<input type="'+e+'" name="'+a+'" id="'+r+'" />').prop("checked",t);break;case"radio":var n=$();for(var s in t){var d,_,l=!1;t[s].push?(_=t[s][0],d=t[s][1]):(_=t[s].val||t[s].value,d=t[s].title||t[s].name),p.radio_default&&p.radio_default==_&&(l=!0),n=n.add($('<input type="radio" name="'+a+'" id="'+r+"-"+_+'" ischecked="'+l+'" />').val(_).prop("checked",l||!l&&0==s)),n=n.add($('<label for="'+r+"-"+_+'"/>').html(d))}}return p.required&&n.prop("required",!0),p.onchange&&(n.on("change.___onchange___",function(e){p.onchange(e,$(this))}),p["default"]&&n.trigger("change")),a||n.attr("name",null),n}p=p||{};var o=$("<p/>").appendTo(this.dom.filter),r="_input_g"+_g.inputIndex,n=n?$('<label for="'+r+'"/>').html(n).appendTo(o):null,d=s().appendTo(o);return"checkbox"==e&&n&&n.insertAfter(d),i&&$('<label for="'+r+'"/>').html(i).appendTo(o),_g.inputIndex++,o},_shiplist.prototype.init=function(){function e(e){var a=$("<thead/>"),n=$("<tr/>").appendTo(a);for(var t in e)"object"==typeof e[t]?$('<td class="stat-'+e[t][1]+'"/>').html('<div class="th-inner">'+e[t][0]+"</div>").appendTo(n):$("<th/>").html('<div class="th-inner">'+e[t]+"</div>").appendTo(n);return a}if(this.is_init)return!0;var a=this;this.dom.filter_container=$('<div class="filter"/>').appendTo(this.dom.section),this.dom.filter=$("<div/>").appendTo(this.dom.filter_container),this.append_option("checkbox","hide-premodel","仅显示同名、同种舰最终版本","false"===_config.get("shiplist-filter-hide-premodel")?null:!0,null,{onchange:function(e,n){_config.set("shiplist-filter-hide-premodel",n.prop("checked")),a.dom.filter_container.attr("filter-hide-premodel",n.prop("checked"))}}),this.append_option("radio","viewtype",null,[["list","列表"],["card","卡片"]],null,{radio_default:_config.get("shiplist-viewtype"),onchange:function(e,n){n.is(":checked")&&(_config.set("shiplist-viewtype",n.val()),a.dom.filter_container.attr("viewtype",n.val()))}}),this.dom.filter.find("input").trigger("change"),this.dom.table_container=$('<div class="fixed-table-container"/>').appendTo(this.dom.section),this.dom.table_container_inner=$('<div class="fixed-table-container-inner"/>').appendTo(this.dom.table_container),this.dom.table=$('<table class="ships hashover hashover-column"/>').appendTo(this.dom.table_container_inner),e(a.columns).appendTo(this.dom.table),this.dom.tbody=$("<tbody/>").appendTo(this.dom.table),_db.ships.find({}).sort({type:1,"class":1,class_no:1,time_created:1,"name.suffix":1}).exec(function(e,n){if(!e&&!_g.data.ship_id_by_type.length)for(var t in n)_g.data.ships[n[t].id]=n[t],"undefined"==typeof _g.data.ship_id_by_type[_g.ship_type_order_map[n[t].type]]&&(_g.data.ship_id_by_type[_g.ship_type_order_map[n[t].type]]=[]),_g.data.ship_id_by_type[_g.ship_type_order_map[n[t].type]].push(n[t].id);_db.ship_types.find({},function(e,t){if(!e){for(var i in t)_g.data.ship_types[t[i].id]=t[i];n&&n.length?a.append_ship_all():$("<p/>").html("暂无数据...").appendTo(a.dom.table_container_inner)}})}),this.is_init=!0},_p.el.itemlist={init_el:function(e){return e.data("itemlist")?!0:void e.data({itemlist:new _itemlist(e)})},init:function(e,a){e=e||$("body"),a=a||e.find("section.itemlist"),a.each(function(){_p.el.itemlist.init_el($(this))})}};var _itemlist=function(e,a){this.dom={section:e},this.columns=["  ",["火力","fire"],["雷装","torpedo"],["爆装","bomb"],["对潜","asw"],["对空","aa"],["装甲","armor"],["回避","evasion"],["命中","hit"],["索敌","los"],["射程","range"]],this.init()};_itemlist.prototype.append_item=function(e){function a(e){return 0==e||"0"==e?'<small class="zero">-</small>':e}var n=this,t=$('<tr data-itemid="'+e.id+'" data-itemedit="'+n.dom.section.hasClass("itemlist-edit")+'"/>').appendTo(this.dom.tbody),i=e.name.zh_cn;for(var p in n.columns)switch(n.columns[p][1]){case" ":$("<th/>").html('<span style="background-image: url(../app/assets/images/itemicon/transparent/'+_g.data.item_types[e.type].icon+'.png)"></span><strong>'+i+"</strong>").appendTo(t);break;case"fire":$('<td class="stat-fire"/>').html(a(e.stat.fire)).appendTo(t);break;case"torpedo":$('<td class="stat-torpedo"/>').html(a(e.stat.torpedo)).appendTo(t);break;case"bomb":$('<td class="stat-bomb"/>').html(a(e.stat.bomb)).appendTo(t);break;case"asw":$('<td class="stat-asw"/>').html(a(e.stat.asw)).appendTo(t);break;case"aa":$('<td class="stat-aa"/>').html(a(e.stat.aa)).appendTo(t);break;case"armor":$('<td class="stat-armor"/>').html(a(e.stat.armor)).appendTo(t);break;case"evasion":$('<td class="stat-evasion"/>').html(a(e.stat.evasion)).appendTo(t);break;case"hit":$('<td class="stat-hit"/>').html(a(e.stat.hit)).appendTo(t);break;case"los":$('<td class="stat-los"/>').html(a(e.stat.los)).appendTo(t);break;case"range":$('<td class="stat-range"/>').html(_g.getStatRange(e.stat.range)).appendTo(t)}return t},_itemlist.prototype.append_item_all=function(){var e=this;for(var a in e.items)e.append_item(_g.data.items[e.items[a]]);for(var n=0;9>n;)$('<tr class="empty"/>').appendTo(this.dom.tbody),n++},_itemlist.prototype.append_option=function(e,a,n,t,i,p){function s(){switch(e){case"text":case"number":case"hidden":var n=$('<input type="'+e+'" name="'+a+'" id="'+r+'" />').val(t);break;case"select":var n=$('<select name="'+a+'" id="'+r+'" />'),i=$('<option value=""/>').html("").appendTo(n);for(var s in t){if("object"==typeof t[s])var o=$('<option value="'+("undefined"==typeof t[s].val?t[s].value:t[s].val)+'"/>').html(t[s].title||t[s].name).appendTo(n);else var o=$('<option value="'+t[s]+'"/>').html(t[s]).appendTo(n);"undefined"!=typeof p["default"]&&o.val()==p["default"]&&o.prop("selected",!0)}t&&t.length||(i.remove(),$('<option value=""/>').html("...").appendTo(n)),p["new"]&&($('<option value=""/>').html("==========").insertAfter(i),$('<option value="___new___"/>').html("+ 新建").insertAfter(i),n.on("change.___new___",function(){var e=$(this);"___new___"==e.val()&&(e.val(""),p["new"](n))}));break;case"checkbox":var n=$('<input type="'+e+'" name="'+a+'" id="'+r+'" />').prop("checked",t);break;case"radio":var n=$();for(var s in t){var d,_,l=!1;t[s].push?(_=t[s][0],d=t[s][1]):(_=t[s].val||t[s].value,d=t[s].title||t[s].name),p.radio_default&&p.radio_default==_&&(l=!0),n=n.add($('<input type="radio" name="'+a+'" id="'+r+"-"+_+'" ischecked="'+l+'" />').val(_).prop("checked",l||!l&&0==s)),n=n.add($('<label for="'+r+"-"+_+'"/>').html(d))}}return p.required&&n.prop("required",!0),p.onchange&&(n.on("change.___onchange___",function(e){p.onchange(e,$(this))}),p["default"]&&n.trigger("change")),a||n.attr("name",null),n}p=p||{};var o=$("<p/>").appendTo(this.dom.filter),r="_input_g"+_g.inputIndex,n=n?$('<label for="'+r+'"/>').html(n).appendTo(o):null,d=s().appendTo(o);return"checkbox"==e&&n&&n.insertAfter(d),i&&$('<label for="'+r+'"/>').html(i).appendTo(o),_g.inputIndex++,o},_itemlist.prototype.init=function(){function e(e){var a=$("<thead/>"),n=$("<tr/>").appendTo(a);for(var t in e)"object"==typeof e[t]?$('<td class="stat-'+e[t][1]+'"/>').html('<div class="th-inner">'+e[t][0]+"</div>").appendTo(n):$("<th/>").html('<div class="th-inner">'+e[t]+"</div>").appendTo(n);return a}if(this.is_init)return!0;var a=this;a.items=[],this.dom.filter_container=$('<div class="filter"/>').appendTo(this.dom.section),this.dom.filter=$("<div/>").appendTo(this.dom.filter_container),this.append_option("radio","viewtype",null,[["list","列表"],["card","卡片"]],null,{radio_default:_config.get("itemlist-viewtype"),onchange:function(e,n){n.is(":checked")&&(_config.set("itemlist-viewtype",n.val()),a.dom.filter_container.attr("viewtype",n.val()))}}),this.dom.filter.find("input").trigger("change"),this.dom.table_container=$('<div class="fixed-table-container"/>').appendTo(this.dom.section),this.dom.table_container_inner=$('<div class="fixed-table-container-inner"/>').appendTo(this.dom.table_container),this.dom.table=$('<table class="items hashover hashover-column"/>').appendTo(this.dom.table_container_inner),e(a.columns).appendTo(this.dom.table),this.dom.tbody=$("<tbody/>").appendTo(this.dom.table),_db.items.find({}).sort({type:1,rarity:1,id:1}).exec(function(e,n){if(!e){for(var t in n)_g.data.items[n[t].id]=n[t],a.items.push(n[t].id);!e&&n&&n.length?a.append_item_all():$("<p/>").html("暂无数据...").appendTo(a.dom.table_container_inner)}}),this.is_init=!0};